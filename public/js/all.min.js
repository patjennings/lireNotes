var start = null;
var d;

// Variables exposées
var key;
var exerciseLength;

var durees = [5,40,80]; // les trois durées disponibles
var notes = ["a", "b", "c", "d", "e", "f", "g"];
var notesFr = ["La", "Si", "Do", "Ré", "Mi", "Fa", "Sol"];
var octaves = [0, 1, 2, 3, 4, 5];
var proposedNote; // la note proposée par l'utilisateur à la position courante
var position = 0; // position de l'utilisateur
var result = 0; // nombre de bonnes réponses
var lineHeight = 6; // hauteur de ligne (référence pour le layout)
var offset = 104; // décalage des notes sur la portée
var interval; // variable pour lancer le comptage du temps
var duration = 0; // durée de la réponse de l'utilisateur (stockée dans inputDuration qd on reçoit une réponse)
var targetTempo = 120;

var notesToDraw = new Array(); // stockage des notes à dessiner
var inputDuration = new Array(); // stockage des temps mis pour répondre
var answersType = new Array(); // stockage des réponses (correctes/incorrectes)

$(document).ready(function () {
    choseOptions();
    $(".overlay #modal-results").hide();
});

function reset(){
    $(".overlay #modal-results").hide();
    $(".overlay #modal-choice").show();
    $(".notes").empty().css("left", offset);
    $(".position").show();

    position = 0;
    result = 0;
    notesToDraw = [];
    inputDuration = [];
    answersType = [];
}

function killListeners(){
    // kill les écouteurs clavier / souris
    $("body").off("keydown");
    $(".note-btn").each(function(){
        $(this).off("click");
    })
}

function getTime(){
    duration++;
}

function captureTime(){
    inputDuration.push(duration);
    duration = 0;
}

// Modale de chois des options, au départ
function choseOptions(){
    var k, l;
    $("#modal-validate").click(function(){
        k = $("#choix-clef").val();
        key = k;
        l = $("#choix-duree").val();
        exerciseLength = durees[l];

        createNotes();
        listenButtons();
        listenKeys();

        $(".overlay").addClass("hidden");
    });
}

// créer le tableau de notes
function createNotes(){

    var c = 0; // pour naviguer dans le tableau des notes

    for (var i = 0; i < exerciseLength ; i++){
        c = getFloorRandomArbitrary(0, notes.length);
        notesToDraw.push(notes[c]);
        drawNotes(notesToDraw[i], key);
    }
}

// Dessiner les notes sur la portée
function drawNotes(note, k){
    var n = note;
    var o = 3;

    $(".portee").removeAttr("id").attr("id", "portee-"+key);

    if(k == "sol"){
        o = getFloorRandomArbitrary(2, 6);
    }
    if(k == "fa"){
        o = getFloorRandomArbitrary(0, 3);
    }

    $(".notes").append("<div class='note "+n+" gr"+o+"'></div>")
}

// fonction utilitaire pour renvoyer un nombre aléatoire entre deux valeurs
function getFloorRandomArbitrary(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

function listenButtons(){
    $(".note-btn").each(function(i){
        $(this).click(function(){
            var classes = $(this).attr('class').split(' ');
            proposedNote = classes[1]; // renvoie le nom de la classe associé au bouton
            setButtonActive();
            sendNote();
        });
    });
}

// Ecouter les touches du clavier
function listenKeys(){
	$("body").keydown(function(event) {
        event.preventDefault();

		if ( event.keyCode == 65 ) { // touche A
            proposedNote = "c";
		}
        else if ( event.keyCode == 90 ) { // touche Z
            proposedNote = "d";
		}
        else if ( event.keyCode == 69 ) { // touche E
            proposedNote = "e";
		}
        else if ( event.keyCode == 82 ) { // touche R
            proposedNote = "f";
		}
        else if ( event.keyCode == 84 ) { // touche T
            proposedNote = "g";
		}
        else if ( event.keyCode == 89 ) { // touche Y
            proposedNote = "a";
		}
        else if ( event.keyCode == 85 ) { // touche U
            proposedNote = "b";
		}
        else{
            proposedNote = "c"; // Si on est dehors, on rétablit sur Do/C
        }

        setButtonActive();
        sendNote();
	});
}

function setButtonActive(){
    $(".note-btn").each(function(i){
        if($(this).hasClass(proposedNote)){
            $(this).addClass('active');
            var intervalID = setTimeout(() => { clearActive($(this)); }, 500);
        }
    });
}

function convertNotesToFr(noteToConvert){
    for(i = 0; i<notes.length; i++){
        if(noteToConvert == notes[i]){
            return notesFr[i];
        }
    }
}

function clearActive(t){
    t.removeClass('active');
}

function sendNote(){
    if(position == 0){
        interval = setInterval("getTime()", 100);
        inputDuration.push(0); // On démarre le chrono, et la première valeur est zéro (on l'enlèvera du décompte final)
    }
    else{
        captureTime();
    }
    controlInput(proposedNote);

    if(position < notesToDraw.length-1){ // Si ce n'est pas fini
        position++;
        getScore();
    }
    else{ // Si c'est terminé
        clearInterval(interval);
        killListeners();
        getFinalScore();
    }
    movePositionForward();
}

// Avancer la tête de lecture
function movePositionForward(){
    var newPos = position*52;

    $(".notes").animate({
        left: (offset+0-newPos)
    },250,function(){
        // something
    });
}

// Contrôler si le résultat entré est le bon
function controlInput(){
    var answerIs;
    var currentNote = $(".notes").find(".note").eq(position);

    if(proposedNote == notesToDraw[position]){
        answerIs = "correct";
        currentNote.append("<div class='correct-note'>check</div>");
        result++;
    }
    else {
        answerIs = "wrong";
        currentNote.append("<div class='correct-note'>"+convertNotesToFr(notesToDraw[position])+"</div>");
    }

    answersType.push(answerIs); // On pushe l'answer dans le tableau des réponses
    currentNote.addClass(answerIs);
}

// Renvoyer l'évolution du result du joueur
function getScore(){
    score = result*100/position;

    console.log("rslt: "+score+" / exLength :"+exerciseLength);
}

// Renvoyer le result du joueur à la fin
function getFinalScore(){
    var tt, tc, score = 0; // temps réponses total, temps réponses correctes
    var totalTime = 0;
    var totalTimeCorrect = 0;
    var totalCorrectAnswers = 0;
    var bpm = 0;
    var timePc = 0;

    for(var i = 1; i < inputDuration.length; i++){
        totalTime += inputDuration[i];
        if(answersType[i] == "correct"){
            totalTimeCorrect += inputDuration[i];
            totalCorrectAnswers++;
        }
    }
    tt = (totalTime/(inputDuration.length - 1))/10;
    tc = (totalTimeCorrect/(totalCorrectAnswers))/10;
    score = result*100/exerciseLength;
    bpm = 60/tc;
    timePc = bpm*100/targetTempo; // 200 = bpm cible

    $(".position").hide();

    displayResultsBox(score, result, tc, tt, bpm, timePc);
}

function displayResultsBox(s, r, tc, tt, bpm, timePc){
    // results + cliquer pour cleaner notes + afficher setup;

    var circleScorePc = Math.floor(s / 10) * 10;
    var circleTimePc = Math.floor(timePc / 10) * 10;

    if(circleTimePc > 99){
        circleTimePc = 100;
    }

    $(".overlay").removeClass("hidden");
    $(".overlay #modal-choice").hide();

    $(".overlay #modal-results").show();
    $("#modal-results .score .column--percent figcaption").empty().append(roundWithPrecision(s, 0)+"<span class='pc'>%</span>");
    $("#modal-results .score .column--percent svg").removeClass("pc-0").addClass("pc-"+circleScorePc);
    $("#modal-results .score .column--sentence h3").empty().append("Continuez !");
    $("#modal-results .score .column--details p").empty().append(roundWithPrecision(r, 2)+" bonnes réponses");
    $("#modal-results .time .column--percent figcaption").empty().append(roundWithPrecision(timePc, 0)+"<span class='pc'>%</span>");
    $("#modal-results .time .column--percent svg").addClass("pc-"+circleTimePc);
    $("#modal-results .time .column--sentence h3").empty().append(roundWithPrecision(bpm, 0)+" à la noire");
    $("#modal-results .time .column--details p").empty().append(roundWithPrecision(tt, 2)+" à toutes les réponses");

    //get bpm score

    $("#modal-reset").click(function(){
        reset();
    });
}

function roundWithPrecision(number, precision){
    var factor = Math.pow(10, precision);
    var tempNumber = number * factor;
    var roundedTempNumber = Math.round(tempNumber);
    return roundedTempNumber / factor;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhbGwubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHN0YXJ0ID0gbnVsbDtcbnZhciBkO1xuXG4vLyBWYXJpYWJsZXMgZXhwb3PDqWVzXG52YXIga2V5O1xudmFyIGV4ZXJjaXNlTGVuZ3RoO1xuXG52YXIgZHVyZWVzID0gWzUsNDAsODBdOyAvLyBsZXMgdHJvaXMgZHVyw6llcyBkaXNwb25pYmxlc1xudmFyIG5vdGVzID0gW1wiYVwiLCBcImJcIiwgXCJjXCIsIFwiZFwiLCBcImVcIiwgXCJmXCIsIFwiZ1wiXTtcbnZhciBub3Rlc0ZyID0gW1wiTGFcIiwgXCJTaVwiLCBcIkRvXCIsIFwiUsOpXCIsIFwiTWlcIiwgXCJGYVwiLCBcIlNvbFwiXTtcbnZhciBvY3RhdmVzID0gWzAsIDEsIDIsIDMsIDQsIDVdO1xudmFyIHByb3Bvc2VkTm90ZTsgLy8gbGEgbm90ZSBwcm9wb3PDqWUgcGFyIGwndXRpbGlzYXRldXIgw6AgbGEgcG9zaXRpb24gY291cmFudGVcbnZhciBwb3NpdGlvbiA9IDA7IC8vIHBvc2l0aW9uIGRlIGwndXRpbGlzYXRldXJcbnZhciByZXN1bHQgPSAwOyAvLyBub21icmUgZGUgYm9ubmVzIHLDqXBvbnNlc1xudmFyIGxpbmVIZWlnaHQgPSA2OyAvLyBoYXV0ZXVyIGRlIGxpZ25lIChyw6lmw6lyZW5jZSBwb3VyIGxlIGxheW91dClcbnZhciBvZmZzZXQgPSAxMDQ7IC8vIGTDqWNhbGFnZSBkZXMgbm90ZXMgc3VyIGxhIHBvcnTDqWVcbnZhciBpbnRlcnZhbDsgLy8gdmFyaWFibGUgcG91ciBsYW5jZXIgbGUgY29tcHRhZ2UgZHUgdGVtcHNcbnZhciBkdXJhdGlvbiA9IDA7IC8vIGR1csOpZSBkZSBsYSByw6lwb25zZSBkZSBsJ3V0aWxpc2F0ZXVyIChzdG9ja8OpZSBkYW5zIGlucHV0RHVyYXRpb24gcWQgb24gcmXDp29pdCB1bmUgcsOpcG9uc2UpXG52YXIgdGFyZ2V0VGVtcG8gPSAxMjA7XG5cbnZhciBub3Rlc1RvRHJhdyA9IG5ldyBBcnJheSgpOyAvLyBzdG9ja2FnZSBkZXMgbm90ZXMgw6AgZGVzc2luZXJcbnZhciBpbnB1dER1cmF0aW9uID0gbmV3IEFycmF5KCk7IC8vIHN0b2NrYWdlIGRlcyB0ZW1wcyBtaXMgcG91ciByw6lwb25kcmVcbnZhciBhbnN3ZXJzVHlwZSA9IG5ldyBBcnJheSgpOyAvLyBzdG9ja2FnZSBkZXMgcsOpcG9uc2VzIChjb3JyZWN0ZXMvaW5jb3JyZWN0ZXMpXG5cbiQoZG9jdW1lbnQpLnJlYWR5KGZ1bmN0aW9uICgpIHtcbiAgICBjaG9zZU9wdGlvbnMoKTtcbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLXJlc3VsdHNcIikuaGlkZSgpO1xufSk7XG5cbmZ1bmN0aW9uIHJlc2V0KCl7XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1yZXN1bHRzXCIpLmhpZGUoKTtcbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLWNob2ljZVwiKS5zaG93KCk7XG4gICAgJChcIi5ub3Rlc1wiKS5lbXB0eSgpLmNzcyhcImxlZnRcIiwgb2Zmc2V0KTtcbiAgICAkKFwiLnBvc2l0aW9uXCIpLnNob3coKTtcblxuICAgIHBvc2l0aW9uID0gMDtcbiAgICByZXN1bHQgPSAwO1xuICAgIG5vdGVzVG9EcmF3ID0gW107XG4gICAgaW5wdXREdXJhdGlvbiA9IFtdO1xuICAgIGFuc3dlcnNUeXBlID0gW107XG59XG5cbmZ1bmN0aW9uIGtpbGxMaXN0ZW5lcnMoKXtcbiAgICAvLyBraWxsIGxlcyDDqWNvdXRldXJzIGNsYXZpZXIgLyBzb3VyaXNcbiAgICAkKFwiYm9keVwiKS5vZmYoXCJrZXlkb3duXCIpO1xuICAgICQoXCIubm90ZS1idG5cIikuZWFjaChmdW5jdGlvbigpe1xuICAgICAgICAkKHRoaXMpLm9mZihcImNsaWNrXCIpO1xuICAgIH0pXG59XG5cbmZ1bmN0aW9uIGdldFRpbWUoKXtcbiAgICBkdXJhdGlvbisrO1xufVxuXG5mdW5jdGlvbiBjYXB0dXJlVGltZSgpe1xuICAgIGlucHV0RHVyYXRpb24ucHVzaChkdXJhdGlvbik7XG4gICAgZHVyYXRpb24gPSAwO1xufVxuXG4vLyBNb2RhbGUgZGUgY2hvaXMgZGVzIG9wdGlvbnMsIGF1IGTDqXBhcnRcbmZ1bmN0aW9uIGNob3NlT3B0aW9ucygpe1xuICAgIHZhciBrLCBsO1xuICAgICQoXCIjbW9kYWwtdmFsaWRhdGVcIikuY2xpY2soZnVuY3Rpb24oKXtcbiAgICAgICAgayA9ICQoXCIjY2hvaXgtY2xlZlwiKS52YWwoKTtcbiAgICAgICAga2V5ID0gaztcbiAgICAgICAgbCA9ICQoXCIjY2hvaXgtZHVyZWVcIikudmFsKCk7XG4gICAgICAgIGV4ZXJjaXNlTGVuZ3RoID0gZHVyZWVzW2xdO1xuXG4gICAgICAgIGNyZWF0ZU5vdGVzKCk7XG4gICAgICAgIGxpc3RlbkJ1dHRvbnMoKTtcbiAgICAgICAgbGlzdGVuS2V5cygpO1xuXG4gICAgICAgICQoXCIub3ZlcmxheVwiKS5hZGRDbGFzcyhcImhpZGRlblwiKTtcbiAgICB9KTtcbn1cblxuLy8gY3LDqWVyIGxlIHRhYmxlYXUgZGUgbm90ZXNcbmZ1bmN0aW9uIGNyZWF0ZU5vdGVzKCl7XG5cbiAgICB2YXIgYyA9IDA7IC8vIHBvdXIgbmF2aWd1ZXIgZGFucyBsZSB0YWJsZWF1IGRlcyBub3Rlc1xuXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBleGVyY2lzZUxlbmd0aCA7IGkrKyl7XG4gICAgICAgIGMgPSBnZXRGbG9vclJhbmRvbUFyYml0cmFyeSgwLCBub3Rlcy5sZW5ndGgpO1xuICAgICAgICBub3Rlc1RvRHJhdy5wdXNoKG5vdGVzW2NdKTtcbiAgICAgICAgZHJhd05vdGVzKG5vdGVzVG9EcmF3W2ldLCBrZXkpO1xuICAgIH1cbn1cblxuLy8gRGVzc2luZXIgbGVzIG5vdGVzIHN1ciBsYSBwb3J0w6llXG5mdW5jdGlvbiBkcmF3Tm90ZXMobm90ZSwgayl7XG4gICAgdmFyIG4gPSBub3RlO1xuICAgIHZhciBvID0gMztcblxuICAgICQoXCIucG9ydGVlXCIpLnJlbW92ZUF0dHIoXCJpZFwiKS5hdHRyKFwiaWRcIiwgXCJwb3J0ZWUtXCIra2V5KTtcblxuICAgIGlmKGsgPT0gXCJzb2xcIil7XG4gICAgICAgIG8gPSBnZXRGbG9vclJhbmRvbUFyYml0cmFyeSgyLCA2KTtcbiAgICB9XG4gICAgaWYoayA9PSBcImZhXCIpe1xuICAgICAgICBvID0gZ2V0Rmxvb3JSYW5kb21BcmJpdHJhcnkoMCwgMyk7XG4gICAgfVxuXG4gICAgJChcIi5ub3Rlc1wiKS5hcHBlbmQoXCI8ZGl2IGNsYXNzPSdub3RlIFwiK24rXCIgZ3JcIitvK1wiJz48L2Rpdj5cIilcbn1cblxuLy8gZm9uY3Rpb24gdXRpbGl0YWlyZSBwb3VyIHJlbnZveWVyIHVuIG5vbWJyZSBhbMOpYXRvaXJlIGVudHJlIGRldXggdmFsZXVyc1xuZnVuY3Rpb24gZ2V0Rmxvb3JSYW5kb21BcmJpdHJhcnkobWluLCBtYXgpIHtcbiAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikgKyBtaW4pO1xufVxuXG5mdW5jdGlvbiBsaXN0ZW5CdXR0b25zKCl7XG4gICAgJChcIi5ub3RlLWJ0blwiKS5lYWNoKGZ1bmN0aW9uKGkpe1xuICAgICAgICAkKHRoaXMpLmNsaWNrKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICB2YXIgY2xhc3NlcyA9ICQodGhpcykuYXR0cignY2xhc3MnKS5zcGxpdCgnICcpO1xuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gY2xhc3Nlc1sxXTsgLy8gcmVudm9pZSBsZSBub20gZGUgbGEgY2xhc3NlIGFzc29jacOpIGF1IGJvdXRvblxuICAgICAgICAgICAgc2V0QnV0dG9uQWN0aXZlKCk7XG4gICAgICAgICAgICBzZW5kTm90ZSgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbn1cblxuLy8gRWNvdXRlciBsZXMgdG91Y2hlcyBkdSBjbGF2aWVyXG5mdW5jdGlvbiBsaXN0ZW5LZXlzKCl7XG5cdCQoXCJib2R5XCIpLmtleWRvd24oZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuXHRcdGlmICggZXZlbnQua2V5Q29kZSA9PSA2NSApIHsgLy8gdG91Y2hlIEFcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiY1wiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gOTAgKSB7IC8vIHRvdWNoZSBaXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImRcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDY5ICkgeyAvLyB0b3VjaGUgRVxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJlXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA4MiApIHsgLy8gdG91Y2hlIFJcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiZlwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODQgKSB7IC8vIHRvdWNoZSBUXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImdcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDg5ICkgeyAvLyB0b3VjaGUgWVxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJhXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA4NSApIHsgLy8gdG91Y2hlIFVcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiYlwiO1xuXHRcdH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiY1wiOyAvLyBTaSBvbiBlc3QgZGVob3JzLCBvbiByw6l0YWJsaXQgc3VyIERvL0NcbiAgICAgICAgfVxuXG4gICAgICAgIHNldEJ1dHRvbkFjdGl2ZSgpO1xuICAgICAgICBzZW5kTm90ZSgpO1xuXHR9KTtcbn1cblxuZnVuY3Rpb24gc2V0QnV0dG9uQWN0aXZlKCl7XG4gICAgJChcIi5ub3RlLWJ0blwiKS5lYWNoKGZ1bmN0aW9uKGkpe1xuICAgICAgICBpZigkKHRoaXMpLmhhc0NsYXNzKHByb3Bvc2VkTm90ZSkpe1xuICAgICAgICAgICAgJCh0aGlzKS5hZGRDbGFzcygnYWN0aXZlJyk7XG4gICAgICAgICAgICB2YXIgaW50ZXJ2YWxJRCA9IHNldFRpbWVvdXQoKCkgPT4geyBjbGVhckFjdGl2ZSgkKHRoaXMpKTsgfSwgNTAwKTtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0Tm90ZXNUb0ZyKG5vdGVUb0NvbnZlcnQpe1xuICAgIGZvcihpID0gMDsgaTxub3Rlcy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIGlmKG5vdGVUb0NvbnZlcnQgPT0gbm90ZXNbaV0pe1xuICAgICAgICAgICAgcmV0dXJuIG5vdGVzRnJbaV07XG4gICAgICAgIH1cbiAgICB9XG59XG5cbmZ1bmN0aW9uIGNsZWFyQWN0aXZlKHQpe1xuICAgIHQucmVtb3ZlQ2xhc3MoJ2FjdGl2ZScpO1xufVxuXG5mdW5jdGlvbiBzZW5kTm90ZSgpe1xuICAgIGlmKHBvc2l0aW9uID09IDApe1xuICAgICAgICBpbnRlcnZhbCA9IHNldEludGVydmFsKFwiZ2V0VGltZSgpXCIsIDEwMCk7XG4gICAgICAgIGlucHV0RHVyYXRpb24ucHVzaCgwKTsgLy8gT24gZMOpbWFycmUgbGUgY2hyb25vLCBldCBsYSBwcmVtacOocmUgdmFsZXVyIGVzdCB6w6lybyAob24gbCdlbmzDqHZlcmEgZHUgZMOpY29tcHRlIGZpbmFsKVxuICAgIH1cbiAgICBlbHNle1xuICAgICAgICBjYXB0dXJlVGltZSgpO1xuICAgIH1cbiAgICBjb250cm9sSW5wdXQocHJvcG9zZWROb3RlKTtcblxuICAgIGlmKHBvc2l0aW9uIDwgbm90ZXNUb0RyYXcubGVuZ3RoLTEpeyAvLyBTaSBjZSBuJ2VzdCBwYXMgZmluaVxuICAgICAgICBwb3NpdGlvbisrO1xuICAgICAgICBnZXRTY29yZSgpO1xuICAgIH1cbiAgICBlbHNleyAvLyBTaSBjJ2VzdCB0ZXJtaW7DqVxuICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgICAga2lsbExpc3RlbmVycygpO1xuICAgICAgICBnZXRGaW5hbFNjb3JlKCk7XG4gICAgfVxuICAgIG1vdmVQb3NpdGlvbkZvcndhcmQoKTtcbn1cblxuLy8gQXZhbmNlciBsYSB0w6p0ZSBkZSBsZWN0dXJlXG5mdW5jdGlvbiBtb3ZlUG9zaXRpb25Gb3J3YXJkKCl7XG4gICAgdmFyIG5ld1BvcyA9IHBvc2l0aW9uKjUyO1xuXG4gICAgJChcIi5ub3Rlc1wiKS5hbmltYXRlKHtcbiAgICAgICAgbGVmdDogKG9mZnNldCswLW5ld1BvcylcbiAgICB9LDI1MCxmdW5jdGlvbigpe1xuICAgICAgICAvLyBzb21ldGhpbmdcbiAgICB9KTtcbn1cblxuLy8gQ29udHLDtGxlciBzaSBsZSByw6lzdWx0YXQgZW50csOpIGVzdCBsZSBib25cbmZ1bmN0aW9uIGNvbnRyb2xJbnB1dCgpe1xuICAgIHZhciBhbnN3ZXJJcztcbiAgICB2YXIgY3VycmVudE5vdGUgPSAkKFwiLm5vdGVzXCIpLmZpbmQoXCIubm90ZVwiKS5lcShwb3NpdGlvbik7XG5cbiAgICBpZihwcm9wb3NlZE5vdGUgPT0gbm90ZXNUb0RyYXdbcG9zaXRpb25dKXtcbiAgICAgICAgYW5zd2VySXMgPSBcImNvcnJlY3RcIjtcbiAgICAgICAgY3VycmVudE5vdGUuYXBwZW5kKFwiPGRpdiBjbGFzcz0nY29ycmVjdC1ub3RlJz5jaGVjazwvZGl2PlwiKTtcbiAgICAgICAgcmVzdWx0Kys7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBhbnN3ZXJJcyA9IFwid3JvbmdcIjtcbiAgICAgICAgY3VycmVudE5vdGUuYXBwZW5kKFwiPGRpdiBjbGFzcz0nY29ycmVjdC1ub3RlJz5cIitjb252ZXJ0Tm90ZXNUb0ZyKG5vdGVzVG9EcmF3W3Bvc2l0aW9uXSkrXCI8L2Rpdj5cIik7XG4gICAgfVxuXG4gICAgYW5zd2Vyc1R5cGUucHVzaChhbnN3ZXJJcyk7IC8vIE9uIHB1c2hlIGwnYW5zd2VyIGRhbnMgbGUgdGFibGVhdSBkZXMgcsOpcG9uc2VzXG4gICAgY3VycmVudE5vdGUuYWRkQ2xhc3MoYW5zd2VySXMpO1xufVxuXG4vLyBSZW52b3llciBsJ8Opdm9sdXRpb24gZHUgcmVzdWx0IGR1IGpvdWV1clxuZnVuY3Rpb24gZ2V0U2NvcmUoKXtcbiAgICBzY29yZSA9IHJlc3VsdCoxMDAvcG9zaXRpb247XG5cbiAgICBjb25zb2xlLmxvZyhcInJzbHQ6IFwiK3Njb3JlK1wiIC8gZXhMZW5ndGggOlwiK2V4ZXJjaXNlTGVuZ3RoKTtcbn1cblxuLy8gUmVudm95ZXIgbGUgcmVzdWx0IGR1IGpvdWV1ciDDoCBsYSBmaW5cbmZ1bmN0aW9uIGdldEZpbmFsU2NvcmUoKXtcbiAgICB2YXIgdHQsIHRjLCBzY29yZSA9IDA7IC8vIHRlbXBzIHLDqXBvbnNlcyB0b3RhbCwgdGVtcHMgcsOpcG9uc2VzIGNvcnJlY3Rlc1xuICAgIHZhciB0b3RhbFRpbWUgPSAwO1xuICAgIHZhciB0b3RhbFRpbWVDb3JyZWN0ID0gMDtcbiAgICB2YXIgdG90YWxDb3JyZWN0QW5zd2VycyA9IDA7XG4gICAgdmFyIGJwbSA9IDA7XG4gICAgdmFyIHRpbWVQYyA9IDA7XG5cbiAgICBmb3IodmFyIGkgPSAxOyBpIDwgaW5wdXREdXJhdGlvbi5sZW5ndGg7IGkrKyl7XG4gICAgICAgIHRvdGFsVGltZSArPSBpbnB1dER1cmF0aW9uW2ldO1xuICAgICAgICBpZihhbnN3ZXJzVHlwZVtpXSA9PSBcImNvcnJlY3RcIil7XG4gICAgICAgICAgICB0b3RhbFRpbWVDb3JyZWN0ICs9IGlucHV0RHVyYXRpb25baV07XG4gICAgICAgICAgICB0b3RhbENvcnJlY3RBbnN3ZXJzKys7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdHQgPSAodG90YWxUaW1lLyhpbnB1dER1cmF0aW9uLmxlbmd0aCAtIDEpKS8xMDtcbiAgICB0YyA9ICh0b3RhbFRpbWVDb3JyZWN0Lyh0b3RhbENvcnJlY3RBbnN3ZXJzKSkvMTA7XG4gICAgc2NvcmUgPSByZXN1bHQqMTAwL2V4ZXJjaXNlTGVuZ3RoO1xuICAgIGJwbSA9IDYwL3RjO1xuICAgIHRpbWVQYyA9IGJwbSoxMDAvdGFyZ2V0VGVtcG87IC8vIDIwMCA9IGJwbSBjaWJsZVxuXG4gICAgJChcIi5wb3NpdGlvblwiKS5oaWRlKCk7XG5cbiAgICBkaXNwbGF5UmVzdWx0c0JveChzY29yZSwgcmVzdWx0LCB0YywgdHQsIGJwbSwgdGltZVBjKTtcbn1cblxuZnVuY3Rpb24gZGlzcGxheVJlc3VsdHNCb3gocywgciwgdGMsIHR0LCBicG0sIHRpbWVQYyl7XG4gICAgLy8gcmVzdWx0cyArIGNsaXF1ZXIgcG91ciBjbGVhbmVyIG5vdGVzICsgYWZmaWNoZXIgc2V0dXA7XG5cbiAgICB2YXIgY2lyY2xlU2NvcmVQYyA9IE1hdGguZmxvb3IocyAvIDEwKSAqIDEwO1xuICAgIHZhciBjaXJjbGVUaW1lUGMgPSBNYXRoLmZsb29yKHRpbWVQYyAvIDEwKSAqIDEwO1xuXG4gICAgaWYoY2lyY2xlVGltZVBjID4gOTkpe1xuICAgICAgICBjaXJjbGVUaW1lUGMgPSAxMDA7XG4gICAgfVxuXG4gICAgJChcIi5vdmVybGF5XCIpLnJlbW92ZUNsYXNzKFwiaGlkZGVuXCIpO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtY2hvaWNlXCIpLmhpZGUoKTtcblxuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5zaG93KCk7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC5zY29yZSAuY29sdW1uLS1wZXJjZW50IGZpZ2NhcHRpb25cIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHMsIDApK1wiPHNwYW4gY2xhc3M9J3BjJz4lPC9zcGFuPlwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLXBlcmNlbnQgc3ZnXCIpLnJlbW92ZUNsYXNzKFwicGMtMFwiKS5hZGRDbGFzcyhcInBjLVwiK2NpcmNsZVNjb3JlUGMpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAuc2NvcmUgLmNvbHVtbi0tc2VudGVuY2UgaDNcIikuZW1wdHkoKS5hcHBlbmQoXCJDb250aW51ZXogIVwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLWRldGFpbHMgcFwiKS5lbXB0eSgpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24ociwgMikrXCIgYm9ubmVzIHLDqXBvbnNlc1wiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnRpbWUgLmNvbHVtbi0tcGVyY2VudCBmaWdjYXB0aW9uXCIpLmVtcHR5KCkuYXBwZW5kKHJvdW5kV2l0aFByZWNpc2lvbih0aW1lUGMsIDApK1wiPHNwYW4gY2xhc3M9J3BjJz4lPC9zcGFuPlwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnRpbWUgLmNvbHVtbi0tcGVyY2VudCBzdmdcIikuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVUaW1lUGMpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1zZW50ZW5jZSBoM1wiKS5lbXB0eSgpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24oYnBtLCAwKStcIiDDoCBsYSBub2lyZVwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnRpbWUgLmNvbHVtbi0tZGV0YWlscyBwXCIpLmVtcHR5KCkuYXBwZW5kKHJvdW5kV2l0aFByZWNpc2lvbih0dCwgMikrXCIgw6AgdG91dGVzIGxlcyByw6lwb25zZXNcIik7XG5cbiAgICAvL2dldCBicG0gc2NvcmVcblxuICAgICQoXCIjbW9kYWwtcmVzZXRcIikuY2xpY2soZnVuY3Rpb24oKXtcbiAgICAgICAgcmVzZXQoKTtcbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gcm91bmRXaXRoUHJlY2lzaW9uKG51bWJlciwgcHJlY2lzaW9uKXtcbiAgICB2YXIgZmFjdG9yID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbik7XG4gICAgdmFyIHRlbXBOdW1iZXIgPSBudW1iZXIgKiBmYWN0b3I7XG4gICAgdmFyIHJvdW5kZWRUZW1wTnVtYmVyID0gTWF0aC5yb3VuZCh0ZW1wTnVtYmVyKTtcbiAgICByZXR1cm4gcm91bmRlZFRlbXBOdW1iZXIgLyBmYWN0b3I7XG59XG4iXX0=
