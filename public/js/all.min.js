var start = null;
var d;

// Variables exposées
var key;
var exerciseLength;

var durees = [5,40,80]; // les trois durées disponibles
var notes = ["a", "b", "c", "d", "e", "f", "g"];
var notesFr = ["La", "Si", "Do", "Ré", "Mi", "Fa", "Sol"];
var octaves = [0, 1, 2, 3, 4, 5];
var proposedNote; // la note proposée par l'utilisateur à la position courante
var position = 0; // position de l'utilisateur
var result = 0; // nombre de bonnes réponses
var lineHeight = 6; // hauteur de ligne (référence pour le layout)
var offset = 104; // décalage des notes sur la portée
var interval; // variable pour lancer le comptage du temps
var duration = 0; // durée de la réponse de l'utilisateur (stockée dans inputDuration qd on reçoit une réponse)
var targetTempo = 120;

var notesToDraw = new Array(); // stockage des notes à dessiner
var inputDuration = new Array(); // stockage des temps mis pour répondre
var answersType = new Array(); // stockage des réponses (correctes/incorrectes)

$(document).ready(function () {
    choseOptions();
    $(".overlay #modal-results").hide();
});

function reset(){
    $(".overlay #modal-results").hide();
    $(".overlay #modal-choice").show();
    $(".notes").empty().css("left", offset);
    $(".position").show();

    position = 0;
    result = 0;
    notesToDraw = [];
    inputDuration = [];
    answersType = [];
}

function killListeners(){
    // kill les écouteurs clavier / souris
    $("body").off("keydown");
    $(".note-btn").each(function(){
        $(this).off("click");
    })
}

function getTime(){
    duration++;
}

function captureTime(){
    inputDuration.push(duration);
    duration = 0;
}

// Modale de chois des options, au départ
function choseOptions(){
    var k, l;
    $("#modal-validate").click(function(){
        k = $("#choix-clef").val();
        key = k;
        l = $("#choix-duree").val();
        exerciseLength = durees[l];

        createNotes();
        listenButtons();
        listenKeys();

        $(".overlay").addClass("hidden");
    });
}

// créer le tableau de notes
function createNotes(){

    var c = 0; // pour naviguer dans le tableau des notes

    for (var i = 0; i < exerciseLength ; i++){
        c = getFloorRandomArbitrary(0, notes.length);
        notesToDraw.push(notes[c]);
        drawNotes(notesToDraw[i], key);
    }
}

// Dessiner les notes sur la portée
function drawNotes(note, k){
    var n = note;
    var o = 3;

    $(".portee").removeAttr("id").attr("id", "portee-"+key);

    if(k == "sol"){
        o = getFloorRandomArbitrary(2, 6);
    }
    if(k == "fa"){
        o = getFloorRandomArbitrary(0, 3);
    }

    $(".notes").append("<div class='note "+n+" gr"+o+"'></div>")
}

// fonction utilitaire pour renvoyer un nombre aléatoire entre deux valeurs
function getFloorRandomArbitrary(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

function listenButtons(){
    $(".note-btn").each(function(i){
        $(this).click(function(){
            var classes = $(this).attr('class').split(' ');
            proposedNote = classes[1]; // renvoie le nom de la classe associé au bouton
            setButtonActive();
            sendNote();
        });
    });
}

// Ecouter les touches du clavier
function listenKeys(){
	$("body").keydown(function(event) {
        event.preventDefault();

		if ( event.keyCode == 65 ) { // touche A
            proposedNote = "c";
		}
        else if ( event.keyCode == 90 ) { // touche Z
            proposedNote = "d";
		}
        else if ( event.keyCode == 69 ) { // touche E
            proposedNote = "e";
		}
        else if ( event.keyCode == 82 ) { // touche R
            proposedNote = "f";
		}
        else if ( event.keyCode == 84 ) { // touche T
            proposedNote = "g";
		}
        else if ( event.keyCode == 89 ) { // touche Y
            proposedNote = "a";
		}
        else if ( event.keyCode == 85 ) { // touche U
            proposedNote = "b";
		}
        else{
            proposedNote = "c"; // Si on est dehors, on rétablit sur Do/C
        }

        setButtonActive();
        sendNote();
	});
}

function setButtonActive(){
    $(".note-btn").each(function(i){
        if($(this).hasClass(proposedNote)){
            $(this).addClass('active');
            var intervalID = setTimeout(() => { clearActive($(this)); }, 500);
        }
    });
}

function convertNotesToFr(noteToConvert){
    for(i = 0; i<notes.length; i++){
        if(noteToConvert == notes[i]){
            return notesFr[i];
        }
    }
}

function clearActive(t){
    t.removeClass('active');
}

function sendNote(){
    if(position == 0){
        interval = setInterval("getTime()", 100);
        inputDuration.push(0); // On démarre le chrono, et la première valeur est zéro (on l'enlèvera du décompte final)
    }
    else{
        captureTime();
    }
    controlInput(proposedNote);

    if(position < notesToDraw.length-1){ // Si ce n'est pas fini
        position++;
        getScore();
    }
    else{ // Si c'est terminé
        clearInterval(interval);
        killListeners();
        getFinalScore();
    }
    movePositionForward();
}

// Avancer la tête de lecture
function movePositionForward(){
    var newPos = position*52;

    $(".notes").animate({
        left: (offset+0-newPos)
    },250,function(){
        // something
    });
}

// Contrôler si le résultat entré est le bon
function controlInput(){
    var answerIs;
    var currentNote = $(".notes").find(".note").eq(position);

    if(proposedNote == notesToDraw[position]){
        answerIs = "correct";
        currentNote.append("<div class='correct-note'>check</div>");
        result++;
    }
    else {
        answerIs = "wrong";
        currentNote.append("<div class='correct-note'>"+convertNotesToFr(notesToDraw[position])+"</div>");
    }

    answersType.push(answerIs); // On pushe l'answer dans le tableau des réponses
    currentNote.addClass(answerIs);
}

// Renvoyer l'évolution du result du joueur
function getScore(){
    score = result*100/position;

    console.log("rslt: "+score+" / exLength :"+exerciseLength);
}

// Renvoyer le result du joueur à la fin
function getFinalScore(){
    var tt, tc, score = 0; // temps réponses total, temps réponses correctes
    var totalTime = 0;
    var totalTimeCorrect = 0;
    var totalCorrectAnswers = 0;
    var bpm = 0;
    var timePc = 0;

    for(var i = 1; i < inputDuration.length; i++){
        totalTime += inputDuration[i];
        if(answersType[i] == "correct"){
            totalTimeCorrect += inputDuration[i];
            totalCorrectAnswers++;
        }
    }
    tt = (totalTime/(inputDuration.length - 1))/10;
    tc = (totalTimeCorrect/(totalCorrectAnswers))/10;
    score = result*100/exerciseLength;
    bpm = 60/tc;
    timePc = bpm*100/targetTempo; // 200 = bpm cible

    $(".position").hide();

    displayResultsBox(score, result, tc, tt, bpm, timePc);
}

function displayResultsBox(s, r, tc, tt, bpm, timePc){
    // results + cliquer pour cleaner notes + afficher setup;

    $(".overlay").removeClass("hidden");
    $(".overlay #modal-choice").hide();

    $(".overlay #modal-results").show();
    $("#modal-results .score .column--percent figcaption").empty().append(roundWithPrecision(s, 0)+"%");
    $("#modal-results .score .column--sentence h3").empty().append("Continuez !");
    $("#modal-results .score .column--details p").empty().append(roundWithPrecision(r, 2)+" bonnes réponses");
    // $("#modal-results .time .time-correct").empty().append(roundWithPrecision(tc, 2)+"s. aux bonnes réponses");
    $("#modal-results .time .column--percent figcaption").empty().append(roundWithPrecision(timePc, 0)+"%");
    $("#modal-results .time .column--sentence h3").empty().append(roundWithPrecision(bpm, 0)+" à la noire");
    $("#modal-results .time .column--details p").empty().append(roundWithPrecision(tt, 2)+" à toutes les réponses");

    //get bpm score


    $("#modal-reset").click(function(){
        reset();
    });
}

function roundWithPrecision(number, precision){
    var factor = Math.pow(10, precision);
    var tempNumber = number * factor;
    var roundedTempNumber = Math.round(tempNumber);
    return roundedTempNumber / factor;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYWxsLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBzdGFydCA9IG51bGw7XG52YXIgZDtcblxuLy8gVmFyaWFibGVzIGV4cG9zw6llc1xudmFyIGtleTtcbnZhciBleGVyY2lzZUxlbmd0aDtcblxudmFyIGR1cmVlcyA9IFs1LDQwLDgwXTsgLy8gbGVzIHRyb2lzIGR1csOpZXMgZGlzcG9uaWJsZXNcbnZhciBub3RlcyA9IFtcImFcIiwgXCJiXCIsIFwiY1wiLCBcImRcIiwgXCJlXCIsIFwiZlwiLCBcImdcIl07XG52YXIgbm90ZXNGciA9IFtcIkxhXCIsIFwiU2lcIiwgXCJEb1wiLCBcIlLDqVwiLCBcIk1pXCIsIFwiRmFcIiwgXCJTb2xcIl07XG52YXIgb2N0YXZlcyA9IFswLCAxLCAyLCAzLCA0LCA1XTtcbnZhciBwcm9wb3NlZE5vdGU7IC8vIGxhIG5vdGUgcHJvcG9zw6llIHBhciBsJ3V0aWxpc2F0ZXVyIMOgIGxhIHBvc2l0aW9uIGNvdXJhbnRlXG52YXIgcG9zaXRpb24gPSAwOyAvLyBwb3NpdGlvbiBkZSBsJ3V0aWxpc2F0ZXVyXG52YXIgcmVzdWx0ID0gMDsgLy8gbm9tYnJlIGRlIGJvbm5lcyByw6lwb25zZXNcbnZhciBsaW5lSGVpZ2h0ID0gNjsgLy8gaGF1dGV1ciBkZSBsaWduZSAocsOpZsOpcmVuY2UgcG91ciBsZSBsYXlvdXQpXG52YXIgb2Zmc2V0ID0gMTA0OyAvLyBkw6ljYWxhZ2UgZGVzIG5vdGVzIHN1ciBsYSBwb3J0w6llXG52YXIgaW50ZXJ2YWw7IC8vIHZhcmlhYmxlIHBvdXIgbGFuY2VyIGxlIGNvbXB0YWdlIGR1IHRlbXBzXG52YXIgZHVyYXRpb24gPSAwOyAvLyBkdXLDqWUgZGUgbGEgcsOpcG9uc2UgZGUgbCd1dGlsaXNhdGV1ciAoc3RvY2vDqWUgZGFucyBpbnB1dER1cmF0aW9uIHFkIG9uIHJlw6dvaXQgdW5lIHLDqXBvbnNlKVxudmFyIHRhcmdldFRlbXBvID0gMTIwO1xuXG52YXIgbm90ZXNUb0RyYXcgPSBuZXcgQXJyYXkoKTsgLy8gc3RvY2thZ2UgZGVzIG5vdGVzIMOgIGRlc3NpbmVyXG52YXIgaW5wdXREdXJhdGlvbiA9IG5ldyBBcnJheSgpOyAvLyBzdG9ja2FnZSBkZXMgdGVtcHMgbWlzIHBvdXIgcsOpcG9uZHJlXG52YXIgYW5zd2Vyc1R5cGUgPSBuZXcgQXJyYXkoKTsgLy8gc3RvY2thZ2UgZGVzIHLDqXBvbnNlcyAoY29ycmVjdGVzL2luY29ycmVjdGVzKVxuXG4kKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XG4gICAgY2hvc2VPcHRpb25zKCk7XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1yZXN1bHRzXCIpLmhpZGUoKTtcbn0pO1xuXG5mdW5jdGlvbiByZXNldCgpe1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5oaWRlKCk7XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1jaG9pY2VcIikuc2hvdygpO1xuICAgICQoXCIubm90ZXNcIikuZW1wdHkoKS5jc3MoXCJsZWZ0XCIsIG9mZnNldCk7XG4gICAgJChcIi5wb3NpdGlvblwiKS5zaG93KCk7XG5cbiAgICBwb3NpdGlvbiA9IDA7XG4gICAgcmVzdWx0ID0gMDtcbiAgICBub3Rlc1RvRHJhdyA9IFtdO1xuICAgIGlucHV0RHVyYXRpb24gPSBbXTtcbiAgICBhbnN3ZXJzVHlwZSA9IFtdO1xufVxuXG5mdW5jdGlvbiBraWxsTGlzdGVuZXJzKCl7XG4gICAgLy8ga2lsbCBsZXMgw6ljb3V0ZXVycyBjbGF2aWVyIC8gc291cmlzXG4gICAgJChcImJvZHlcIikub2ZmKFwia2V5ZG93blwiKTtcbiAgICAkKFwiLm5vdGUtYnRuXCIpLmVhY2goZnVuY3Rpb24oKXtcbiAgICAgICAgJCh0aGlzKS5vZmYoXCJjbGlja1wiKTtcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBnZXRUaW1lKCl7XG4gICAgZHVyYXRpb24rKztcbn1cblxuZnVuY3Rpb24gY2FwdHVyZVRpbWUoKXtcbiAgICBpbnB1dER1cmF0aW9uLnB1c2goZHVyYXRpb24pO1xuICAgIGR1cmF0aW9uID0gMDtcbn1cblxuLy8gTW9kYWxlIGRlIGNob2lzIGRlcyBvcHRpb25zLCBhdSBkw6lwYXJ0XG5mdW5jdGlvbiBjaG9zZU9wdGlvbnMoKXtcbiAgICB2YXIgaywgbDtcbiAgICAkKFwiI21vZGFsLXZhbGlkYXRlXCIpLmNsaWNrKGZ1bmN0aW9uKCl7XG4gICAgICAgIGsgPSAkKFwiI2Nob2l4LWNsZWZcIikudmFsKCk7XG4gICAgICAgIGtleSA9IGs7XG4gICAgICAgIGwgPSAkKFwiI2Nob2l4LWR1cmVlXCIpLnZhbCgpO1xuICAgICAgICBleGVyY2lzZUxlbmd0aCA9IGR1cmVlc1tsXTtcblxuICAgICAgICBjcmVhdGVOb3RlcygpO1xuICAgICAgICBsaXN0ZW5CdXR0b25zKCk7XG4gICAgICAgIGxpc3RlbktleXMoKTtcblxuICAgICAgICAkKFwiLm92ZXJsYXlcIikuYWRkQ2xhc3MoXCJoaWRkZW5cIik7XG4gICAgfSk7XG59XG5cbi8vIGNyw6llciBsZSB0YWJsZWF1IGRlIG5vdGVzXG5mdW5jdGlvbiBjcmVhdGVOb3Rlcygpe1xuXG4gICAgdmFyIGMgPSAwOyAvLyBwb3VyIG5hdmlndWVyIGRhbnMgbGUgdGFibGVhdSBkZXMgbm90ZXNcblxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXhlcmNpc2VMZW5ndGggOyBpKyspe1xuICAgICAgICBjID0gZ2V0Rmxvb3JSYW5kb21BcmJpdHJhcnkoMCwgbm90ZXMubGVuZ3RoKTtcbiAgICAgICAgbm90ZXNUb0RyYXcucHVzaChub3Rlc1tjXSk7XG4gICAgICAgIGRyYXdOb3Rlcyhub3Rlc1RvRHJhd1tpXSwga2V5KTtcbiAgICB9XG59XG5cbi8vIERlc3NpbmVyIGxlcyBub3RlcyBzdXIgbGEgcG9ydMOpZVxuZnVuY3Rpb24gZHJhd05vdGVzKG5vdGUsIGspe1xuICAgIHZhciBuID0gbm90ZTtcbiAgICB2YXIgbyA9IDM7XG5cbiAgICAkKFwiLnBvcnRlZVwiKS5yZW1vdmVBdHRyKFwiaWRcIikuYXR0cihcImlkXCIsIFwicG9ydGVlLVwiK2tleSk7XG5cbiAgICBpZihrID09IFwic29sXCIpe1xuICAgICAgICBvID0gZ2V0Rmxvb3JSYW5kb21BcmJpdHJhcnkoMiwgNik7XG4gICAgfVxuICAgIGlmKGsgPT0gXCJmYVwiKXtcbiAgICAgICAgbyA9IGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KDAsIDMpO1xuICAgIH1cblxuICAgICQoXCIubm90ZXNcIikuYXBwZW5kKFwiPGRpdiBjbGFzcz0nbm90ZSBcIituK1wiIGdyXCIrbytcIic+PC9kaXY+XCIpXG59XG5cbi8vIGZvbmN0aW9uIHV0aWxpdGFpcmUgcG91ciByZW52b3llciB1biBub21icmUgYWzDqWF0b2lyZSBlbnRyZSBkZXV4IHZhbGV1cnNcbmZ1bmN0aW9uIGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KG1pbiwgbWF4KSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pICsgbWluKTtcbn1cblxuZnVuY3Rpb24gbGlzdGVuQnV0dG9ucygpe1xuICAgICQoXCIubm90ZS1idG5cIikuZWFjaChmdW5jdGlvbihpKXtcbiAgICAgICAgJCh0aGlzKS5jbGljayhmdW5jdGlvbigpe1xuICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSAkKHRoaXMpLmF0dHIoJ2NsYXNzJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IGNsYXNzZXNbMV07IC8vIHJlbnZvaWUgbGUgbm9tIGRlIGxhIGNsYXNzZSBhc3NvY2nDqSBhdSBib3V0b25cbiAgICAgICAgICAgIHNldEJ1dHRvbkFjdGl2ZSgpO1xuICAgICAgICAgICAgc2VuZE5vdGUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbi8vIEVjb3V0ZXIgbGVzIHRvdWNoZXMgZHUgY2xhdmllclxuZnVuY3Rpb24gbGlzdGVuS2V5cygpe1xuXHQkKFwiYm9keVwiKS5rZXlkb3duKGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRpZiAoIGV2ZW50LmtleUNvZGUgPT0gNjUgKSB7IC8vIHRvdWNoZSBBXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImNcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDkwICkgeyAvLyB0b3VjaGUgWlxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJkXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA2OSApIHsgLy8gdG91Y2hlIEVcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiZVwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODIgKSB7IC8vIHRvdWNoZSBSXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImZcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDg0ICkgeyAvLyB0b3VjaGUgVFxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJnXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA4OSApIHsgLy8gdG91Y2hlIFlcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiYVwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODUgKSB7IC8vIHRvdWNoZSBVXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImJcIjtcblx0XHR9XG4gICAgICAgIGVsc2V7XG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImNcIjsgLy8gU2kgb24gZXN0IGRlaG9ycywgb24gcsOpdGFibGl0IHN1ciBEby9DXG4gICAgICAgIH1cblxuICAgICAgICBzZXRCdXR0b25BY3RpdmUoKTtcbiAgICAgICAgc2VuZE5vdGUoKTtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIHNldEJ1dHRvbkFjdGl2ZSgpe1xuICAgICQoXCIubm90ZS1idG5cIikuZWFjaChmdW5jdGlvbihpKXtcbiAgICAgICAgaWYoJCh0aGlzKS5oYXNDbGFzcyhwcm9wb3NlZE5vdGUpKXtcbiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgdmFyIGludGVydmFsSUQgPSBzZXRUaW1lb3V0KCgpID0+IHsgY2xlYXJBY3RpdmUoJCh0aGlzKSk7IH0sIDUwMCk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gY29udmVydE5vdGVzVG9Gcihub3RlVG9Db252ZXJ0KXtcbiAgICBmb3IoaSA9IDA7IGk8bm90ZXMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZihub3RlVG9Db252ZXJ0ID09IG5vdGVzW2ldKXtcbiAgICAgICAgICAgIHJldHVybiBub3Rlc0ZyW2ldO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjbGVhckFjdGl2ZSh0KXtcbiAgICB0LnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbn1cblxuZnVuY3Rpb24gc2VuZE5vdGUoKXtcbiAgICBpZihwb3NpdGlvbiA9PSAwKXtcbiAgICAgICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChcImdldFRpbWUoKVwiLCAxMDApO1xuICAgICAgICBpbnB1dER1cmF0aW9uLnB1c2goMCk7IC8vIE9uIGTDqW1hcnJlIGxlIGNocm9ubywgZXQgbGEgcHJlbWnDqHJlIHZhbGV1ciBlc3QgesOpcm8gKG9uIGwnZW5sw6h2ZXJhIGR1IGTDqWNvbXB0ZSBmaW5hbClcbiAgICB9XG4gICAgZWxzZXtcbiAgICAgICAgY2FwdHVyZVRpbWUoKTtcbiAgICB9XG4gICAgY29udHJvbElucHV0KHByb3Bvc2VkTm90ZSk7XG5cbiAgICBpZihwb3NpdGlvbiA8IG5vdGVzVG9EcmF3Lmxlbmd0aC0xKXsgLy8gU2kgY2Ugbidlc3QgcGFzIGZpbmlcbiAgICAgICAgcG9zaXRpb24rKztcbiAgICAgICAgZ2V0U2NvcmUoKTtcbiAgICB9XG4gICAgZWxzZXsgLy8gU2kgYydlc3QgdGVybWluw6lcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgIGtpbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgZ2V0RmluYWxTY29yZSgpO1xuICAgIH1cbiAgICBtb3ZlUG9zaXRpb25Gb3J3YXJkKCk7XG59XG5cbi8vIEF2YW5jZXIgbGEgdMOqdGUgZGUgbGVjdHVyZVxuZnVuY3Rpb24gbW92ZVBvc2l0aW9uRm9yd2FyZCgpe1xuICAgIHZhciBuZXdQb3MgPSBwb3NpdGlvbio1MjtcblxuICAgICQoXCIubm90ZXNcIikuYW5pbWF0ZSh7XG4gICAgICAgIGxlZnQ6IChvZmZzZXQrMC1uZXdQb3MpXG4gICAgfSwyNTAsZnVuY3Rpb24oKXtcbiAgICAgICAgLy8gc29tZXRoaW5nXG4gICAgfSk7XG59XG5cbi8vIENvbnRyw7RsZXIgc2kgbGUgcsOpc3VsdGF0IGVudHLDqSBlc3QgbGUgYm9uXG5mdW5jdGlvbiBjb250cm9sSW5wdXQoKXtcbiAgICB2YXIgYW5zd2VySXM7XG4gICAgdmFyIGN1cnJlbnROb3RlID0gJChcIi5ub3Rlc1wiKS5maW5kKFwiLm5vdGVcIikuZXEocG9zaXRpb24pO1xuXG4gICAgaWYocHJvcG9zZWROb3RlID09IG5vdGVzVG9EcmF3W3Bvc2l0aW9uXSl7XG4gICAgICAgIGFuc3dlcklzID0gXCJjb3JyZWN0XCI7XG4gICAgICAgIGN1cnJlbnROb3RlLmFwcGVuZChcIjxkaXYgY2xhc3M9J2NvcnJlY3Qtbm90ZSc+Y2hlY2s8L2Rpdj5cIik7XG4gICAgICAgIHJlc3VsdCsrO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgYW5zd2VySXMgPSBcIndyb25nXCI7XG4gICAgICAgIGN1cnJlbnROb3RlLmFwcGVuZChcIjxkaXYgY2xhc3M9J2NvcnJlY3Qtbm90ZSc+XCIrY29udmVydE5vdGVzVG9Gcihub3Rlc1RvRHJhd1twb3NpdGlvbl0pK1wiPC9kaXY+XCIpO1xuICAgIH1cblxuICAgIGFuc3dlcnNUeXBlLnB1c2goYW5zd2VySXMpOyAvLyBPbiBwdXNoZSBsJ2Fuc3dlciBkYW5zIGxlIHRhYmxlYXUgZGVzIHLDqXBvbnNlc1xuICAgIGN1cnJlbnROb3RlLmFkZENsYXNzKGFuc3dlcklzKTtcbn1cblxuLy8gUmVudm95ZXIgbCfDqXZvbHV0aW9uIGR1IHJlc3VsdCBkdSBqb3VldXJcbmZ1bmN0aW9uIGdldFNjb3JlKCl7XG4gICAgc2NvcmUgPSByZXN1bHQqMTAwL3Bvc2l0aW9uO1xuXG4gICAgY29uc29sZS5sb2coXCJyc2x0OiBcIitzY29yZStcIiAvIGV4TGVuZ3RoIDpcIitleGVyY2lzZUxlbmd0aCk7XG59XG5cbi8vIFJlbnZveWVyIGxlIHJlc3VsdCBkdSBqb3VldXIgw6AgbGEgZmluXG5mdW5jdGlvbiBnZXRGaW5hbFNjb3JlKCl7XG4gICAgdmFyIHR0LCB0Yywgc2NvcmUgPSAwOyAvLyB0ZW1wcyByw6lwb25zZXMgdG90YWwsIHRlbXBzIHLDqXBvbnNlcyBjb3JyZWN0ZXNcbiAgICB2YXIgdG90YWxUaW1lID0gMDtcbiAgICB2YXIgdG90YWxUaW1lQ29ycmVjdCA9IDA7XG4gICAgdmFyIHRvdGFsQ29ycmVjdEFuc3dlcnMgPSAwO1xuICAgIHZhciBicG0gPSAwO1xuICAgIHZhciB0aW1lUGMgPSAwO1xuXG4gICAgZm9yKHZhciBpID0gMTsgaSA8IGlucHV0RHVyYXRpb24ubGVuZ3RoOyBpKyspe1xuICAgICAgICB0b3RhbFRpbWUgKz0gaW5wdXREdXJhdGlvbltpXTtcbiAgICAgICAgaWYoYW5zd2Vyc1R5cGVbaV0gPT0gXCJjb3JyZWN0XCIpe1xuICAgICAgICAgICAgdG90YWxUaW1lQ29ycmVjdCArPSBpbnB1dER1cmF0aW9uW2ldO1xuICAgICAgICAgICAgdG90YWxDb3JyZWN0QW5zd2VycysrO1xuICAgICAgICB9XG4gICAgfVxuICAgIHR0ID0gKHRvdGFsVGltZS8oaW5wdXREdXJhdGlvbi5sZW5ndGggLSAxKSkvMTA7XG4gICAgdGMgPSAodG90YWxUaW1lQ29ycmVjdC8odG90YWxDb3JyZWN0QW5zd2VycykpLzEwO1xuICAgIHNjb3JlID0gcmVzdWx0KjEwMC9leGVyY2lzZUxlbmd0aDtcbiAgICBicG0gPSA2MC90YztcbiAgICB0aW1lUGMgPSBicG0qMTAwL3RhcmdldFRlbXBvOyAvLyAyMDAgPSBicG0gY2libGVcblxuICAgICQoXCIucG9zaXRpb25cIikuaGlkZSgpO1xuXG4gICAgZGlzcGxheVJlc3VsdHNCb3goc2NvcmUsIHJlc3VsdCwgdGMsIHR0LCBicG0sIHRpbWVQYyk7XG59XG5cbmZ1bmN0aW9uIGRpc3BsYXlSZXN1bHRzQm94KHMsIHIsIHRjLCB0dCwgYnBtLCB0aW1lUGMpe1xuICAgIC8vIHJlc3VsdHMgKyBjbGlxdWVyIHBvdXIgY2xlYW5lciBub3RlcyArIGFmZmljaGVyIHNldHVwO1xuXG4gICAgJChcIi5vdmVybGF5XCIpLnJlbW92ZUNsYXNzKFwiaGlkZGVuXCIpO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtY2hvaWNlXCIpLmhpZGUoKTtcblxuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5zaG93KCk7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC5zY29yZSAuY29sdW1uLS1wZXJjZW50IGZpZ2NhcHRpb25cIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHMsIDApK1wiJVwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLXNlbnRlbmNlIGgzXCIpLmVtcHR5KCkuYXBwZW5kKFwiQ29udGludWV6ICFcIik7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC5zY29yZSAuY29sdW1uLS1kZXRhaWxzIHBcIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHIsIDIpK1wiIGJvbm5lcyByw6lwb25zZXNcIik7XG4gICAgLy8gJChcIiNtb2RhbC1yZXN1bHRzIC50aW1lIC50aW1lLWNvcnJlY3RcIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHRjLCAyKStcInMuIGF1eCBib25uZXMgcsOpcG9uc2VzXCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1wZXJjZW50IGZpZ2NhcHRpb25cIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHRpbWVQYywgMCkrXCIlXCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1zZW50ZW5jZSBoM1wiKS5lbXB0eSgpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24oYnBtLCAwKStcIiDDoCBsYSBub2lyZVwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnRpbWUgLmNvbHVtbi0tZGV0YWlscyBwXCIpLmVtcHR5KCkuYXBwZW5kKHJvdW5kV2l0aFByZWNpc2lvbih0dCwgMikrXCIgw6AgdG91dGVzIGxlcyByw6lwb25zZXNcIik7XG5cbiAgICAvL2dldCBicG0gc2NvcmVcblxuXG4gICAgJChcIiNtb2RhbC1yZXNldFwiKS5jbGljayhmdW5jdGlvbigpe1xuICAgICAgICByZXNldCgpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiByb3VuZFdpdGhQcmVjaXNpb24obnVtYmVyLCBwcmVjaXNpb24pe1xuICAgIHZhciBmYWN0b3IgPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uKTtcbiAgICB2YXIgdGVtcE51bWJlciA9IG51bWJlciAqIGZhY3RvcjtcbiAgICB2YXIgcm91bmRlZFRlbXBOdW1iZXIgPSBNYXRoLnJvdW5kKHRlbXBOdW1iZXIpO1xuICAgIHJldHVybiByb3VuZGVkVGVtcE51bWJlciAvIGZhY3Rvcjtcbn1cbiJdfQ==
