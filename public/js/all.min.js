// Tout le code est créé from scratch par Thomas Guesnon en 2017. http://www.thomasguesnon.fr
// Avec l'aide de jQuery quand même, et de growl.jquery.js pour les notifs — cf. ligne 88.
var start = null;
var d;

// Variables exposées
var key;
var exerciseLength;

var durees = [20,40,80]; // les trois durées disponibles
var notes = ["a", "b", "c", "d", "e", "f", "g"];
var notesChosen = [0, 0, 0, 0, 0, 0, 0];
var notesFr = ["La", "Si", "Do", "Ré", "Mi", "Fa", "Sol"];
var octaves = [0, 1, 2, 3, 4, 5];
var proposedNote; // la note proposée par l'utilisateur à la position courante
var position = 0; // position de l'utilisateur
var result = 0; // nombre de bonnes réponses
var lineHeight = 6; // hauteur de ligne (référence pour le layout)
var offset = 260; // décalage des notes sur la portée
var interval; // variable pour lancer le comptage du temps
var duration = 0; // durée de la réponse de l'utilisateur (stockée dans inputDuration qd on reçoit une réponse)
var targetTempo = 120;
var checked = 0; // sert à contrôler qu'on a bien sélectionné au moins deux notes dans choseOptions();

var notesChosen = new Array();
var notesToDraw = new Array(); // stockage des notes à dessiner
var inputDuration = new Array(); // stockage des temps mis pour répondre
var answersType = new Array(); // stockage des réponses (correctes/incorrectes)

$(document).ready(function () {
    choseOptions();
    notesChosen = [0, 0, 0, 0, 0, 0, 0];
    $(".overlay #modal-results").hide();
});

function reset(){
    $(".overlay #modal-results").hide();
    $(".overlay #modal-choice").show();
    $(".notes").empty().css("left", offset);
    $(".position").show();

    position = 0;
    result = 0;
    notesToDraw = [];
    notesChosen = [0, 0, 0, 0, 0, 0, 0];
    checked = 0;
    inputDuration = [];
    answersType = [];
}

function killListeners(){
    // kill les écouteurs clavier / souris
    $("body").off("keydown");
    $(".note-btn").each(function(){
        $(this).off("click");
    })
}

function getTime(){
    duration++;
}

function captureTime(){
    inputDuration.push(duration);
    duration = 0;
}

// Modale de chois des options, au départ
function choseOptions(){

    var k, l;
    $("#modal-validate").click(function(){
        k = $("#choix-clef").val();
        key = k;
        l = $("#choix-duree").val();
        exerciseLength = durees[l];

        $('.form--checkbox input').each(function(){
            if($(this).is(':checked')){
                var v = $(this).attr("value");
                notesChosen[v] = 1;
                checked++;
            }
        });

        //
        if(checked < 2){
            $.growl.error({ title: "Trop peu de notes", message: "Veuillez sélectionner au moins deux notes à afficher sur la portée" });
            checked = 0;
        }
        else{
            createNotes();
            listenButtons();
            listenKeys();

            $(".overlay").addClass("hidden");
        }

    });
}

// créer le tableau de notes
function createNotes(){

    var c = 0; // pour naviguer dans le tableau des notes
    var i = 0;

    while(i < exerciseLength){
        c = getFloorRandomArbitrary(0, notes.length);

        if(notesChosen[c] == 1){
            console.log("ok");
            notesToDraw.push(notes[c]);
            drawNotes(notesToDraw[i], key);
            i++;
        }
        else {
            console.log("no");
        }

    }

    console.log(notesToDraw);
}

// Dessiner les notes sur la portée
function drawNotes(note, k){
    var n = note;
    var o = 3;

    $(".portee").removeAttr("id").attr("id", "portee-"+key);

    if(k == "sol"){
        o = getFloorRandomArbitrary(2, 6);
    }
    if(k == "fa"){
        o = getFloorRandomArbitrary(0, 3);
    }

    $(".notes").append("<div class='note "+n+" gr"+o+"'></div>")
}

// fonction utilitaire pour renvoyer un nombre aléatoire entre deux valeurs
function getFloorRandomArbitrary(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

function listenButtons(){
    $(".note-btn").each(function(i){
        $(this).click(function(){
            var classes = $(this).attr('class').split(' ');
            proposedNote = classes[1]; // renvoie le nom de la classe associé au bouton
            setButtonActive();
            sendNote();
        });
    });
}

// Ecouter les touches du clavier
function listenKeys(){
	$("body").keydown(function(event) {
        event.preventDefault();

		if ( event.keyCode == 65 ) { // touche A
            proposedNote = "c";
		}
        else if ( event.keyCode == 90 ) { // touche Z
            proposedNote = "d";
		}
        else if ( event.keyCode == 69 ) { // touche E
            proposedNote = "e";
		}
        else if ( event.keyCode == 82 ) { // touche R
            proposedNote = "f";
		}
        else if ( event.keyCode == 84 ) { // touche T
            proposedNote = "g";
		}
        else if ( event.keyCode == 89 ) { // touche Y
            proposedNote = "a";
		}
        else if ( event.keyCode == 85 ) { // touche U
            proposedNote = "b";
		}
        else{
            proposedNote = "c"; // Si on est dehors, on rétablit sur Do/C
        }

        setButtonActive();
        sendNote();
	});
}

function setButtonActive(){
    $(".note-btn").each(function(i){
        if($(this).hasClass(proposedNote)){
            $(this).addClass('active');
            var intervalID = setTimeout(() => { clearActive($(this)); }, 500);
        }
    });
}

function convertNotesToFr(noteToConvert){
    for(i = 0; i<notes.length; i++){
        if(noteToConvert == notes[i]){
            return notesFr[i];
        }
    }
}

function clearActive(t){
    t.removeClass('active');
}

function sendNote(){
    if(position == 0){
        interval = setInterval("getTime()", 100);
        inputDuration.push(0); // On démarre le chrono, et la première valeur est zéro (on l'enlèvera du décompte final)
    }
    else{
        captureTime();
    }
    controlInput(proposedNote);

    if(position < notesToDraw.length-1){ // Si ce n'est pas fini
        position++;
        getScore();
    }
    else{ // Si c'est terminé
        clearInterval(interval);
        killListeners();
        getFinalScore();
    }
    movePositionForward();
}

// Avancer la tête de lecture
function movePositionForward(){
    var newPos = position*52;

    $(".notes").animate({
        left: (offset+0-newPos)
    },250,function(){
        // something
    });
}

// Contrôler si le résultat entré est le bon
function controlInput(){
    var answerIs;
    var currentNote = $(".notes").find(".note").eq(position);

    if(proposedNote == notesToDraw[position]){
        answerIs = "correct";
        currentNote.append("<div class='check-note'>✓</div>");
        result++;
    }
    else {
        answerIs = "wrong";
        currentNote.append("<div class='correct-note'>"+convertNotesToFr(notesToDraw[position])+"</div>");
    }

    answersType.push(answerIs); // On pushe l'answer dans le tableau des réponses
    currentNote.addClass(answerIs);
}

// Renvoyer l'évolution du result du joueur
function getScore(){
    score = result*100/position;

    // console.log("rslt: "+score+" / exLength :"+exerciseLength);
}

// Renvoyer le result du joueur à la fin
function getFinalScore(){
    var tt, tc, score = 0; // temps réponses total, temps réponses correctes
    var totalTime = 0;
    var totalTimeCorrect = 0;
    var totalCorrectAnswers = 0;
    var bpm = 0;
    var timePc = 0;

    for(var i = 1; i < inputDuration.length; i++){
        totalTime += inputDuration[i];
        if(answersType[i] == "correct"){
            totalTimeCorrect += inputDuration[i];
            totalCorrectAnswers++;
        }
    }
    tt = (totalTime/(inputDuration.length - 1))/10;
    tc = (totalTimeCorrect/(totalCorrectAnswers))/10;
    score = result*100/exerciseLength;
    bpm = 60/tc;
    timePc = bpm*100/targetTempo; // 200 = bpm cible

    $(".position").hide();

    displayResultsBox(score, result, tc, tt, bpm, timePc);
}

function displayResultsBox(s, r, tc, tt, bpm, timePc){
    // results + cliquer pour cleaner notes + afficher setup;

    var circleScorePc = Math.floor(s / 10) * 10;
    var circleTimePc = Math.floor(timePc / 10) * 10;

    if(circleTimePc > 99){
        circleTimePc = 100;
    }

    $(".overlay").removeClass("hidden");
    $(".overlay #modal-choice").hide();

    $(".overlay #modal-results").css("opacity", 0);
    $(".overlay #modal-results").css("display", "block");
    $(".overlay #modal-results").animate({
        opacity: 1,
    }, 1000);
    $("#modal-results .score .column--percent figcaption").empty().removeClass().addClass("pc-"+circleScorePc).append(roundWithPrecision(s, 0)+"<span class='pc'>%</span>");
    $("#modal-results .score .column--percent svg").removeClass().addClass("pc-"+circleScorePc);
    $("#modal-results .score .column--sentence h3").empty().removeClass().addClass("pc-"+circleScorePc).append("Continuez !");
    $("#modal-results .score .column--details p").empty().append(roundWithPrecision(r, 2)+" bonnes réponses");
    $("#modal-results .time .column--percent figcaption").empty().removeClass().addClass("pc-"+circleTimePc).append(roundWithPrecision(timePc, 0)+"<span class='pc'>%</span>");
    $("#modal-results .time .column--percent svg").removeClass().addClass("pc-"+circleTimePc);
    $("#modal-results .time .column--sentence h3").empty().removeClass().addClass("pc-"+circleTimePc).append("<img src='public/assets/images/note.svg' class='time--note'/> = "+roundWithPrecision(bpm, 0));
    // $("#modal-results .time .column--details p").empty().append(roundWithPrecision(tt, 2)+" à toutes les réponses");

    //get bpm score

    $("#modal-reset").click(function(){
        reset();
    });
}

function roundWithPrecision(number, precision){
    var factor = Math.pow(10, precision);
    var tempNumber = number * factor;
    var roundedTempNumber = Math.round(tempNumber);
    return roundedTempNumber / factor;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYWxsLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRvdXQgbGUgY29kZSBlc3QgY3LDqcOpIGZyb20gc2NyYXRjaCBwYXIgVGhvbWFzIEd1ZXNub24gZW4gMjAxNy4gaHR0cDovL3d3dy50aG9tYXNndWVzbm9uLmZyXG4vLyBBdmVjIGwnYWlkZSBkZSBqUXVlcnkgcXVhbmQgbcOqbWUsIGV0IGRlIGdyb3dsLmpxdWVyeS5qcyBwb3VyIGxlcyBub3RpZnMg4oCUIGNmLiBsaWduZSA4OC5cbnZhciBzdGFydCA9IG51bGw7XG52YXIgZDtcblxuLy8gVmFyaWFibGVzIGV4cG9zw6llc1xudmFyIGtleTtcbnZhciBleGVyY2lzZUxlbmd0aDtcblxudmFyIGR1cmVlcyA9IFsyMCw0MCw4MF07IC8vIGxlcyB0cm9pcyBkdXLDqWVzIGRpc3BvbmlibGVzXG52YXIgbm90ZXMgPSBbXCJhXCIsIFwiYlwiLCBcImNcIiwgXCJkXCIsIFwiZVwiLCBcImZcIiwgXCJnXCJdO1xudmFyIG5vdGVzQ2hvc2VuID0gWzAsIDAsIDAsIDAsIDAsIDAsIDBdO1xudmFyIG5vdGVzRnIgPSBbXCJMYVwiLCBcIlNpXCIsIFwiRG9cIiwgXCJSw6lcIiwgXCJNaVwiLCBcIkZhXCIsIFwiU29sXCJdO1xudmFyIG9jdGF2ZXMgPSBbMCwgMSwgMiwgMywgNCwgNV07XG52YXIgcHJvcG9zZWROb3RlOyAvLyBsYSBub3RlIHByb3Bvc8OpZSBwYXIgbCd1dGlsaXNhdGV1ciDDoCBsYSBwb3NpdGlvbiBjb3VyYW50ZVxudmFyIHBvc2l0aW9uID0gMDsgLy8gcG9zaXRpb24gZGUgbCd1dGlsaXNhdGV1clxudmFyIHJlc3VsdCA9IDA7IC8vIG5vbWJyZSBkZSBib25uZXMgcsOpcG9uc2VzXG52YXIgbGluZUhlaWdodCA9IDY7IC8vIGhhdXRldXIgZGUgbGlnbmUgKHLDqWbDqXJlbmNlIHBvdXIgbGUgbGF5b3V0KVxudmFyIG9mZnNldCA9IDI2MDsgLy8gZMOpY2FsYWdlIGRlcyBub3RlcyBzdXIgbGEgcG9ydMOpZVxudmFyIGludGVydmFsOyAvLyB2YXJpYWJsZSBwb3VyIGxhbmNlciBsZSBjb21wdGFnZSBkdSB0ZW1wc1xudmFyIGR1cmF0aW9uID0gMDsgLy8gZHVyw6llIGRlIGxhIHLDqXBvbnNlIGRlIGwndXRpbGlzYXRldXIgKHN0b2Nrw6llIGRhbnMgaW5wdXREdXJhdGlvbiBxZCBvbiByZcOnb2l0IHVuZSByw6lwb25zZSlcbnZhciB0YXJnZXRUZW1wbyA9IDEyMDtcbnZhciBjaGVja2VkID0gMDsgLy8gc2VydCDDoCBjb250csO0bGVyIHF1J29uIGEgYmllbiBzw6lsZWN0aW9ubsOpIGF1IG1vaW5zIGRldXggbm90ZXMgZGFucyBjaG9zZU9wdGlvbnMoKTtcblxudmFyIG5vdGVzQ2hvc2VuID0gbmV3IEFycmF5KCk7XG52YXIgbm90ZXNUb0RyYXcgPSBuZXcgQXJyYXkoKTsgLy8gc3RvY2thZ2UgZGVzIG5vdGVzIMOgIGRlc3NpbmVyXG52YXIgaW5wdXREdXJhdGlvbiA9IG5ldyBBcnJheSgpOyAvLyBzdG9ja2FnZSBkZXMgdGVtcHMgbWlzIHBvdXIgcsOpcG9uZHJlXG52YXIgYW5zd2Vyc1R5cGUgPSBuZXcgQXJyYXkoKTsgLy8gc3RvY2thZ2UgZGVzIHLDqXBvbnNlcyAoY29ycmVjdGVzL2luY29ycmVjdGVzKVxuXG4kKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbiAoKSB7XG4gICAgY2hvc2VPcHRpb25zKCk7XG4gICAgbm90ZXNDaG9zZW4gPSBbMCwgMCwgMCwgMCwgMCwgMCwgMF07XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1yZXN1bHRzXCIpLmhpZGUoKTtcbn0pO1xuXG5mdW5jdGlvbiByZXNldCgpe1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5oaWRlKCk7XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1jaG9pY2VcIikuc2hvdygpO1xuICAgICQoXCIubm90ZXNcIikuZW1wdHkoKS5jc3MoXCJsZWZ0XCIsIG9mZnNldCk7XG4gICAgJChcIi5wb3NpdGlvblwiKS5zaG93KCk7XG5cbiAgICBwb3NpdGlvbiA9IDA7XG4gICAgcmVzdWx0ID0gMDtcbiAgICBub3Rlc1RvRHJhdyA9IFtdO1xuICAgIG5vdGVzQ2hvc2VuID0gWzAsIDAsIDAsIDAsIDAsIDAsIDBdO1xuICAgIGNoZWNrZWQgPSAwO1xuICAgIGlucHV0RHVyYXRpb24gPSBbXTtcbiAgICBhbnN3ZXJzVHlwZSA9IFtdO1xufVxuXG5mdW5jdGlvbiBraWxsTGlzdGVuZXJzKCl7XG4gICAgLy8ga2lsbCBsZXMgw6ljb3V0ZXVycyBjbGF2aWVyIC8gc291cmlzXG4gICAgJChcImJvZHlcIikub2ZmKFwia2V5ZG93blwiKTtcbiAgICAkKFwiLm5vdGUtYnRuXCIpLmVhY2goZnVuY3Rpb24oKXtcbiAgICAgICAgJCh0aGlzKS5vZmYoXCJjbGlja1wiKTtcbiAgICB9KVxufVxuXG5mdW5jdGlvbiBnZXRUaW1lKCl7XG4gICAgZHVyYXRpb24rKztcbn1cblxuZnVuY3Rpb24gY2FwdHVyZVRpbWUoKXtcbiAgICBpbnB1dER1cmF0aW9uLnB1c2goZHVyYXRpb24pO1xuICAgIGR1cmF0aW9uID0gMDtcbn1cblxuLy8gTW9kYWxlIGRlIGNob2lzIGRlcyBvcHRpb25zLCBhdSBkw6lwYXJ0XG5mdW5jdGlvbiBjaG9zZU9wdGlvbnMoKXtcblxuICAgIHZhciBrLCBsO1xuICAgICQoXCIjbW9kYWwtdmFsaWRhdGVcIikuY2xpY2soZnVuY3Rpb24oKXtcbiAgICAgICAgayA9ICQoXCIjY2hvaXgtY2xlZlwiKS52YWwoKTtcbiAgICAgICAga2V5ID0gaztcbiAgICAgICAgbCA9ICQoXCIjY2hvaXgtZHVyZWVcIikudmFsKCk7XG4gICAgICAgIGV4ZXJjaXNlTGVuZ3RoID0gZHVyZWVzW2xdO1xuXG4gICAgICAgICQoJy5mb3JtLS1jaGVja2JveCBpbnB1dCcpLmVhY2goZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIGlmKCQodGhpcykuaXMoJzpjaGVja2VkJykpe1xuICAgICAgICAgICAgICAgIHZhciB2ID0gJCh0aGlzKS5hdHRyKFwidmFsdWVcIik7XG4gICAgICAgICAgICAgICAgbm90ZXNDaG9zZW5bdl0gPSAxO1xuICAgICAgICAgICAgICAgIGNoZWNrZWQrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9cbiAgICAgICAgaWYoY2hlY2tlZCA8IDIpe1xuICAgICAgICAgICAgJC5ncm93bC5lcnJvcih7IHRpdGxlOiBcIlRyb3AgcGV1IGRlIG5vdGVzXCIsIG1lc3NhZ2U6IFwiVmV1aWxsZXogc8OpbGVjdGlvbm5lciBhdSBtb2lucyBkZXV4IG5vdGVzIMOgIGFmZmljaGVyIHN1ciBsYSBwb3J0w6llXCIgfSk7XG4gICAgICAgICAgICBjaGVja2VkID0gMDtcbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgY3JlYXRlTm90ZXMoKTtcbiAgICAgICAgICAgIGxpc3RlbkJ1dHRvbnMoKTtcbiAgICAgICAgICAgIGxpc3RlbktleXMoKTtcblxuICAgICAgICAgICAgJChcIi5vdmVybGF5XCIpLmFkZENsYXNzKFwiaGlkZGVuXCIpO1xuICAgICAgICB9XG5cbiAgICB9KTtcbn1cblxuLy8gY3LDqWVyIGxlIHRhYmxlYXUgZGUgbm90ZXNcbmZ1bmN0aW9uIGNyZWF0ZU5vdGVzKCl7XG5cbiAgICB2YXIgYyA9IDA7IC8vIHBvdXIgbmF2aWd1ZXIgZGFucyBsZSB0YWJsZWF1IGRlcyBub3Rlc1xuICAgIHZhciBpID0gMDtcblxuICAgIHdoaWxlKGkgPCBleGVyY2lzZUxlbmd0aCl7XG4gICAgICAgIGMgPSBnZXRGbG9vclJhbmRvbUFyYml0cmFyeSgwLCBub3Rlcy5sZW5ndGgpO1xuXG4gICAgICAgIGlmKG5vdGVzQ2hvc2VuW2NdID09IDEpe1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJva1wiKTtcbiAgICAgICAgICAgIG5vdGVzVG9EcmF3LnB1c2gobm90ZXNbY10pO1xuICAgICAgICAgICAgZHJhd05vdGVzKG5vdGVzVG9EcmF3W2ldLCBrZXkpO1xuICAgICAgICAgICAgaSsrO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJub1wiKTtcbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgY29uc29sZS5sb2cobm90ZXNUb0RyYXcpO1xufVxuXG4vLyBEZXNzaW5lciBsZXMgbm90ZXMgc3VyIGxhIHBvcnTDqWVcbmZ1bmN0aW9uIGRyYXdOb3Rlcyhub3RlLCBrKXtcbiAgICB2YXIgbiA9IG5vdGU7XG4gICAgdmFyIG8gPSAzO1xuXG4gICAgJChcIi5wb3J0ZWVcIikucmVtb3ZlQXR0cihcImlkXCIpLmF0dHIoXCJpZFwiLCBcInBvcnRlZS1cIitrZXkpO1xuXG4gICAgaWYoayA9PSBcInNvbFwiKXtcbiAgICAgICAgbyA9IGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KDIsIDYpO1xuICAgIH1cbiAgICBpZihrID09IFwiZmFcIil7XG4gICAgICAgIG8gPSBnZXRGbG9vclJhbmRvbUFyYml0cmFyeSgwLCAzKTtcbiAgICB9XG5cbiAgICAkKFwiLm5vdGVzXCIpLmFwcGVuZChcIjxkaXYgY2xhc3M9J25vdGUgXCIrbitcIiBnclwiK28rXCInPjwvZGl2PlwiKVxufVxuXG4vLyBmb25jdGlvbiB1dGlsaXRhaXJlIHBvdXIgcmVudm95ZXIgdW4gbm9tYnJlIGFsw6lhdG9pcmUgZW50cmUgZGV1eCB2YWxldXJzXG5mdW5jdGlvbiBnZXRGbG9vclJhbmRvbUFyYml0cmFyeShtaW4sIG1heCkge1xuICAgIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSArIG1pbik7XG59XG5cbmZ1bmN0aW9uIGxpc3RlbkJ1dHRvbnMoKXtcbiAgICAkKFwiLm5vdGUtYnRuXCIpLmVhY2goZnVuY3Rpb24oaSl7XG4gICAgICAgICQodGhpcykuY2xpY2soZnVuY3Rpb24oKXtcbiAgICAgICAgICAgIHZhciBjbGFzc2VzID0gJCh0aGlzKS5hdHRyKCdjbGFzcycpLnNwbGl0KCcgJyk7XG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBjbGFzc2VzWzFdOyAvLyByZW52b2llIGxlIG5vbSBkZSBsYSBjbGFzc2UgYXNzb2Npw6kgYXUgYm91dG9uXG4gICAgICAgICAgICBzZXRCdXR0b25BY3RpdmUoKTtcbiAgICAgICAgICAgIHNlbmROb3RlKCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuXG4vLyBFY291dGVyIGxlcyB0b3VjaGVzIGR1IGNsYXZpZXJcbmZ1bmN0aW9uIGxpc3RlbktleXMoKXtcblx0JChcImJvZHlcIikua2V5ZG93bihmdW5jdGlvbihldmVudCkge1xuICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG5cdFx0aWYgKCBldmVudC5rZXlDb2RlID09IDY1ICkgeyAvLyB0b3VjaGUgQVxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJjXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA5MCApIHsgLy8gdG91Y2hlIFpcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiZFwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gNjkgKSB7IC8vIHRvdWNoZSBFXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImVcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDgyICkgeyAvLyB0b3VjaGUgUlxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJmXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA4NCApIHsgLy8gdG91Y2hlIFRcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiZ1wiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODkgKSB7IC8vIHRvdWNoZSBZXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImFcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDg1ICkgeyAvLyB0b3VjaGUgVVxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJiXCI7XG5cdFx0fVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJjXCI7IC8vIFNpIG9uIGVzdCBkZWhvcnMsIG9uIHLDqXRhYmxpdCBzdXIgRG8vQ1xuICAgICAgICB9XG5cbiAgICAgICAgc2V0QnV0dG9uQWN0aXZlKCk7XG4gICAgICAgIHNlbmROb3RlKCk7XG5cdH0pO1xufVxuXG5mdW5jdGlvbiBzZXRCdXR0b25BY3RpdmUoKXtcbiAgICAkKFwiLm5vdGUtYnRuXCIpLmVhY2goZnVuY3Rpb24oaSl7XG4gICAgICAgIGlmKCQodGhpcykuaGFzQ2xhc3MocHJvcG9zZWROb3RlKSl7XG4gICAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKCdhY3RpdmUnKTtcbiAgICAgICAgICAgIHZhciBpbnRlcnZhbElEID0gc2V0VGltZW91dCgoKSA9PiB7IGNsZWFyQWN0aXZlKCQodGhpcykpOyB9LCA1MDApO1xuICAgICAgICB9XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnROb3Rlc1RvRnIobm90ZVRvQ29udmVydCl7XG4gICAgZm9yKGkgPSAwOyBpPG5vdGVzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYobm90ZVRvQ29udmVydCA9PSBub3Rlc1tpXSl7XG4gICAgICAgICAgICByZXR1cm4gbm90ZXNGcltpXTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gY2xlYXJBY3RpdmUodCl7XG4gICAgdC5yZW1vdmVDbGFzcygnYWN0aXZlJyk7XG59XG5cbmZ1bmN0aW9uIHNlbmROb3RlKCl7XG4gICAgaWYocG9zaXRpb24gPT0gMCl7XG4gICAgICAgIGludGVydmFsID0gc2V0SW50ZXJ2YWwoXCJnZXRUaW1lKClcIiwgMTAwKTtcbiAgICAgICAgaW5wdXREdXJhdGlvbi5wdXNoKDApOyAvLyBPbiBkw6ltYXJyZSBsZSBjaHJvbm8sIGV0IGxhIHByZW1pw6hyZSB2YWxldXIgZXN0IHrDqXJvIChvbiBsJ2VubMOodmVyYSBkdSBkw6ljb21wdGUgZmluYWwpXG4gICAgfVxuICAgIGVsc2V7XG4gICAgICAgIGNhcHR1cmVUaW1lKCk7XG4gICAgfVxuICAgIGNvbnRyb2xJbnB1dChwcm9wb3NlZE5vdGUpO1xuXG4gICAgaWYocG9zaXRpb24gPCBub3Rlc1RvRHJhdy5sZW5ndGgtMSl7IC8vIFNpIGNlIG4nZXN0IHBhcyBmaW5pXG4gICAgICAgIHBvc2l0aW9uKys7XG4gICAgICAgIGdldFNjb3JlKCk7XG4gICAgfVxuICAgIGVsc2V7IC8vIFNpIGMnZXN0IHRlcm1pbsOpXG4gICAgICAgIGNsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xuICAgICAgICBraWxsTGlzdGVuZXJzKCk7XG4gICAgICAgIGdldEZpbmFsU2NvcmUoKTtcbiAgICB9XG4gICAgbW92ZVBvc2l0aW9uRm9yd2FyZCgpO1xufVxuXG4vLyBBdmFuY2VyIGxhIHTDqnRlIGRlIGxlY3R1cmVcbmZ1bmN0aW9uIG1vdmVQb3NpdGlvbkZvcndhcmQoKXtcbiAgICB2YXIgbmV3UG9zID0gcG9zaXRpb24qNTI7XG5cbiAgICAkKFwiLm5vdGVzXCIpLmFuaW1hdGUoe1xuICAgICAgICBsZWZ0OiAob2Zmc2V0KzAtbmV3UG9zKVxuICAgIH0sMjUwLGZ1bmN0aW9uKCl7XG4gICAgICAgIC8vIHNvbWV0aGluZ1xuICAgIH0pO1xufVxuXG4vLyBDb250csO0bGVyIHNpIGxlIHLDqXN1bHRhdCBlbnRyw6kgZXN0IGxlIGJvblxuZnVuY3Rpb24gY29udHJvbElucHV0KCl7XG4gICAgdmFyIGFuc3dlcklzO1xuICAgIHZhciBjdXJyZW50Tm90ZSA9ICQoXCIubm90ZXNcIikuZmluZChcIi5ub3RlXCIpLmVxKHBvc2l0aW9uKTtcblxuICAgIGlmKHByb3Bvc2VkTm90ZSA9PSBub3Rlc1RvRHJhd1twb3NpdGlvbl0pe1xuICAgICAgICBhbnN3ZXJJcyA9IFwiY29ycmVjdFwiO1xuICAgICAgICBjdXJyZW50Tm90ZS5hcHBlbmQoXCI8ZGl2IGNsYXNzPSdjaGVjay1ub3RlJz7inJM8L2Rpdj5cIik7XG4gICAgICAgIHJlc3VsdCsrO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgYW5zd2VySXMgPSBcIndyb25nXCI7XG4gICAgICAgIGN1cnJlbnROb3RlLmFwcGVuZChcIjxkaXYgY2xhc3M9J2NvcnJlY3Qtbm90ZSc+XCIrY29udmVydE5vdGVzVG9Gcihub3Rlc1RvRHJhd1twb3NpdGlvbl0pK1wiPC9kaXY+XCIpO1xuICAgIH1cblxuICAgIGFuc3dlcnNUeXBlLnB1c2goYW5zd2VySXMpOyAvLyBPbiBwdXNoZSBsJ2Fuc3dlciBkYW5zIGxlIHRhYmxlYXUgZGVzIHLDqXBvbnNlc1xuICAgIGN1cnJlbnROb3RlLmFkZENsYXNzKGFuc3dlcklzKTtcbn1cblxuLy8gUmVudm95ZXIgbCfDqXZvbHV0aW9uIGR1IHJlc3VsdCBkdSBqb3VldXJcbmZ1bmN0aW9uIGdldFNjb3JlKCl7XG4gICAgc2NvcmUgPSByZXN1bHQqMTAwL3Bvc2l0aW9uO1xuXG4gICAgLy8gY29uc29sZS5sb2coXCJyc2x0OiBcIitzY29yZStcIiAvIGV4TGVuZ3RoIDpcIitleGVyY2lzZUxlbmd0aCk7XG59XG5cbi8vIFJlbnZveWVyIGxlIHJlc3VsdCBkdSBqb3VldXIgw6AgbGEgZmluXG5mdW5jdGlvbiBnZXRGaW5hbFNjb3JlKCl7XG4gICAgdmFyIHR0LCB0Yywgc2NvcmUgPSAwOyAvLyB0ZW1wcyByw6lwb25zZXMgdG90YWwsIHRlbXBzIHLDqXBvbnNlcyBjb3JyZWN0ZXNcbiAgICB2YXIgdG90YWxUaW1lID0gMDtcbiAgICB2YXIgdG90YWxUaW1lQ29ycmVjdCA9IDA7XG4gICAgdmFyIHRvdGFsQ29ycmVjdEFuc3dlcnMgPSAwO1xuICAgIHZhciBicG0gPSAwO1xuICAgIHZhciB0aW1lUGMgPSAwO1xuXG4gICAgZm9yKHZhciBpID0gMTsgaSA8IGlucHV0RHVyYXRpb24ubGVuZ3RoOyBpKyspe1xuICAgICAgICB0b3RhbFRpbWUgKz0gaW5wdXREdXJhdGlvbltpXTtcbiAgICAgICAgaWYoYW5zd2Vyc1R5cGVbaV0gPT0gXCJjb3JyZWN0XCIpe1xuICAgICAgICAgICAgdG90YWxUaW1lQ29ycmVjdCArPSBpbnB1dER1cmF0aW9uW2ldO1xuICAgICAgICAgICAgdG90YWxDb3JyZWN0QW5zd2VycysrO1xuICAgICAgICB9XG4gICAgfVxuICAgIHR0ID0gKHRvdGFsVGltZS8oaW5wdXREdXJhdGlvbi5sZW5ndGggLSAxKSkvMTA7XG4gICAgdGMgPSAodG90YWxUaW1lQ29ycmVjdC8odG90YWxDb3JyZWN0QW5zd2VycykpLzEwO1xuICAgIHNjb3JlID0gcmVzdWx0KjEwMC9leGVyY2lzZUxlbmd0aDtcbiAgICBicG0gPSA2MC90YztcbiAgICB0aW1lUGMgPSBicG0qMTAwL3RhcmdldFRlbXBvOyAvLyAyMDAgPSBicG0gY2libGVcblxuICAgICQoXCIucG9zaXRpb25cIikuaGlkZSgpO1xuXG4gICAgZGlzcGxheVJlc3VsdHNCb3goc2NvcmUsIHJlc3VsdCwgdGMsIHR0LCBicG0sIHRpbWVQYyk7XG59XG5cbmZ1bmN0aW9uIGRpc3BsYXlSZXN1bHRzQm94KHMsIHIsIHRjLCB0dCwgYnBtLCB0aW1lUGMpe1xuICAgIC8vIHJlc3VsdHMgKyBjbGlxdWVyIHBvdXIgY2xlYW5lciBub3RlcyArIGFmZmljaGVyIHNldHVwO1xuXG4gICAgdmFyIGNpcmNsZVNjb3JlUGMgPSBNYXRoLmZsb29yKHMgLyAxMCkgKiAxMDtcbiAgICB2YXIgY2lyY2xlVGltZVBjID0gTWF0aC5mbG9vcih0aW1lUGMgLyAxMCkgKiAxMDtcblxuICAgIGlmKGNpcmNsZVRpbWVQYyA+IDk5KXtcbiAgICAgICAgY2lyY2xlVGltZVBjID0gMTAwO1xuICAgIH1cblxuICAgICQoXCIub3ZlcmxheVwiKS5yZW1vdmVDbGFzcyhcImhpZGRlblwiKTtcbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLWNob2ljZVwiKS5oaWRlKCk7XG5cbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLXJlc3VsdHNcIikuY3NzKFwib3BhY2l0eVwiLCAwKTtcbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLXJlc3VsdHNcIikuY3NzKFwiZGlzcGxheVwiLCBcImJsb2NrXCIpO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5hbmltYXRlKHtcbiAgICAgICAgb3BhY2l0eTogMSxcbiAgICB9LCAxMDAwKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLXBlcmNlbnQgZmlnY2FwdGlvblwiKS5lbXB0eSgpLnJlbW92ZUNsYXNzKCkuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVTY29yZVBjKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHMsIDApK1wiPHNwYW4gY2xhc3M9J3BjJz4lPC9zcGFuPlwiKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLXBlcmNlbnQgc3ZnXCIpLnJlbW92ZUNsYXNzKCkuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVTY29yZVBjKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnNjb3JlIC5jb2x1bW4tLXNlbnRlbmNlIGgzXCIpLmVtcHR5KCkucmVtb3ZlQ2xhc3MoKS5hZGRDbGFzcyhcInBjLVwiK2NpcmNsZVNjb3JlUGMpLmFwcGVuZChcIkNvbnRpbnVleiAhXCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAuc2NvcmUgLmNvbHVtbi0tZGV0YWlscyBwXCIpLmVtcHR5KCkuYXBwZW5kKHJvdW5kV2l0aFByZWNpc2lvbihyLCAyKStcIiBib25uZXMgcsOpcG9uc2VzXCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1wZXJjZW50IGZpZ2NhcHRpb25cIikuZW1wdHkoKS5yZW1vdmVDbGFzcygpLmFkZENsYXNzKFwicGMtXCIrY2lyY2xlVGltZVBjKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHRpbWVQYywgMCkrXCI8c3BhbiBjbGFzcz0ncGMnPiU8L3NwYW4+XCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1wZXJjZW50IHN2Z1wiKS5yZW1vdmVDbGFzcygpLmFkZENsYXNzKFwicGMtXCIrY2lyY2xlVGltZVBjKTtcbiAgICAkKFwiI21vZGFsLXJlc3VsdHMgLnRpbWUgLmNvbHVtbi0tc2VudGVuY2UgaDNcIikuZW1wdHkoKS5yZW1vdmVDbGFzcygpLmFkZENsYXNzKFwicGMtXCIrY2lyY2xlVGltZVBjKS5hcHBlbmQoXCI8aW1nIHNyYz0ncHVibGljL2Fzc2V0cy9pbWFnZXMvbm90ZS5zdmcnIGNsYXNzPSd0aW1lLS1ub3RlJy8+ID0gXCIrcm91bmRXaXRoUHJlY2lzaW9uKGJwbSwgMCkpO1xuICAgIC8vICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1kZXRhaWxzIHBcIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHR0LCAyKStcIiDDoCB0b3V0ZXMgbGVzIHLDqXBvbnNlc1wiKTtcblxuICAgIC8vZ2V0IGJwbSBzY29yZVxuXG4gICAgJChcIiNtb2RhbC1yZXNldFwiKS5jbGljayhmdW5jdGlvbigpe1xuICAgICAgICByZXNldCgpO1xuICAgIH0pO1xufVxuXG5mdW5jdGlvbiByb3VuZFdpdGhQcmVjaXNpb24obnVtYmVyLCBwcmVjaXNpb24pe1xuICAgIHZhciBmYWN0b3IgPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uKTtcbiAgICB2YXIgdGVtcE51bWJlciA9IG51bWJlciAqIGZhY3RvcjtcbiAgICB2YXIgcm91bmRlZFRlbXBOdW1iZXIgPSBNYXRoLnJvdW5kKHRlbXBOdW1iZXIpO1xuICAgIHJldHVybiByb3VuZGVkVGVtcE51bWJlciAvIGZhY3Rvcjtcbn1cbiJdfQ==
