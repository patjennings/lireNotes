// Tout le code est créé from scratch par Thomas Guesnon en 2017. http://www.thomasguesnon.fr
// Avec l'aide de jQuery quand même, et de growl.jquery.js pour les notifs — cf. ligne 88.
var start = null;
var d;

// Variables exposées
var key;
var exerciseLength;

var durees = [20,40,80]; // les trois durées disponibles
var notes = ["a", "b", "c", "d", "e", "f", "g"];
var notesChosen = [0, 0, 0, 0, 0, 0, 0];
var notesFr = ["La", "Si", "Do", "Ré", "Mi", "Fa", "Sol"];
var octaves = [0, 1, 2, 3, 4, 5];
var proposedNote; // la note proposée par l'utilisateur à la position courante
var position = 0; // position de l'utilisateur
var result = 0; // nombre de bonnes réponses
var lineHeight = 6; // hauteur de ligne (référence pour le layout)
var offset = 260; // décalage des notes sur la portée
var interval; // variable pour lancer le comptage du temps
var duration = 0; // durée de la réponse de l'utilisateur (stockée dans inputDuration qd on reçoit une réponse)
var targetTempo = 120;
var checked = 0; // sert à contrôler qu'on a bien sélectionné au moins deux notes dans choseOptions();

var notesChosen = new Array();
var notesToDraw = new Array(); // stockage des notes à dessiner
var inputDuration = new Array(); // stockage des temps mis pour répondre
var answersType = new Array(); // stockage des réponses (correctes/incorrectes)

$(document).ready(function () {
    choseOptions();
    notesChosen = [0, 0, 0, 0, 0, 0, 0];
    $(".overlay #modal-results").hide();
});

function reset(){
    $(".overlay #modal-results").hide();
    $(".overlay #modal-choice").show();
    $(".notes").empty().css("left", offset);
    $(".position").show();

    position = 0;
    result = 0;
    notesToDraw = [];
    notesChosen = [0, 0, 0, 0, 0, 0, 0];
    checked = 0;
    inputDuration = [];
    answersType = [];
}

function killListeners(){
    // kill les écouteurs clavier / souris
    $("body").off("keydown");
    $(".note-btn").each(function(){
        $(this).off("click");
    })
}

function getTime(){
    duration++;
}

function captureTime(){
    inputDuration.push(duration);
    duration = 0;
}

// Modale de chois des options, au départ
function choseOptions(){

    var k, l;
    $("#modal-validate").click(function(){
        k = $("#choix-clef").val();
        key = k;
        l = $("#choix-duree").val();
        exerciseLength = durees[l];

        $('.form--checkbox input').each(function(){
            if($(this).is(':checked')){
                var v = $(this).attr("value");
                notesChosen[v] = 1;
                checked++;
            }
        });

        //
        if(checked < 2){
            $.growl.error({ title: "Trop peu de notes", message: "Veuillez sélectionner au moins deux notes à afficher sur la portée" });
            checked = 0;
        }
        else{
            createNotes();
            listenButtons();
            listenKeys();

            $(".overlay").addClass("hidden");
        }

        console.log(notesChosen);

    });
}

// créer le tableau de notes
function createNotes(){

    var c = 0; // pour naviguer dans le tableau des notes
    var i = 0;

    while(i < exerciseLength){
        c = getFloorRandomArbitrary(0, notes.length);

        if(notesChosen[c] == 1){
            console.log("ok");
            notesToDraw.push(notes[c]);
            drawNotes(notesToDraw[i], key);
            i++;
        }
        else {
            console.log("no");
        }

    }

    console.log(notesToDraw);
}

// Dessiner les notes sur la portée
function drawNotes(note, k){
    var n = note;
    var o = 3;

    $(".portee").removeAttr("id").attr("id", "portee-"+key);

    if(k == "sol"){
        o = getFloorRandomArbitrary(2, 6);
    }
    if(k == "fa"){
        o = getFloorRandomArbitrary(0, 3);
    }

    $(".notes").append("<div class='note "+n+" gr"+o+"'></div>")
}

// fonction utilitaire pour renvoyer un nombre aléatoire entre deux valeurs
function getFloorRandomArbitrary(min, max) {
    return Math.floor(Math.random() * (max - min) + min);
}

function listenButtons(){
    $(".note-btn").each(function(i){
        $(this).click(function(){
            var classes = $(this).attr('class').split(' ');
            proposedNote = classes[1]; // renvoie le nom de la classe associé au bouton
            setButtonActive();
            sendNote();
        });
    });
}

// Ecouter les touches du clavier
function listenKeys(){
	$("body").keydown(function(event) {
        event.preventDefault();

		if ( event.keyCode == 65 ) { // touche A
            proposedNote = "c";
		}
        else if ( event.keyCode == 90 ) { // touche Z
            proposedNote = "d";
		}
        else if ( event.keyCode == 69 ) { // touche E
            proposedNote = "e";
		}
        else if ( event.keyCode == 82 ) { // touche R
            proposedNote = "f";
		}
        else if ( event.keyCode == 84 ) { // touche T
            proposedNote = "g";
		}
        else if ( event.keyCode == 89 ) { // touche Y
            proposedNote = "a";
		}
        else if ( event.keyCode == 85 ) { // touche U
            proposedNote = "b";
		}
        else{
            proposedNote = "c"; // Si on est dehors, on rétablit sur Do/C
        }

        setButtonActive();
        sendNote();
	});
}

function setButtonActive(){
    $(".note-btn").each(function(i){
        if($(this).hasClass(proposedNote)){
            $(this).addClass('active');
            var intervalID = setTimeout(() => { clearActive($(this)); }, 500);
        }
    });
}

function convertNotesToFr(noteToConvert){
    for(i = 0; i<notes.length; i++){
        if(noteToConvert == notes[i]){
            return notesFr[i];
        }
    }
}

function clearActive(t){
    t.removeClass('active');
}

function sendNote(){
    if(position == 0){
        interval = setInterval("getTime()", 100);
        inputDuration.push(0); // On démarre le chrono, et la première valeur est zéro (on l'enlèvera du décompte final)
    }
    else{
        captureTime();
    }
    controlInput(proposedNote);

    if(position < notesToDraw.length-1){ // Si ce n'est pas fini
        position++;
        getScore();
    }
    else{ // Si c'est terminé
        clearInterval(interval);
        killListeners();
        getFinalScore();
    }
    movePositionForward();
}

// Avancer la tête de lecture
function movePositionForward(){
    var newPos = position*52;

    $(".notes").animate({
        left: (offset+0-newPos)
    },250,function(){
        // something
    });
}

// Contrôler si le résultat entré est le bon
function controlInput(){
    var answerIs;
    var currentNote = $(".notes").find(".note").eq(position);

    if(proposedNote == notesToDraw[position]){
        answerIs = "correct";
        currentNote.append("<div class='check-note'>✓</div>");
        result++;
    }
    else {
        answerIs = "wrong";
        currentNote.append("<div class='correct-note'>"+convertNotesToFr(notesToDraw[position])+"</div>");
    }

    answersType.push(answerIs); // On pushe l'answer dans le tableau des réponses
    currentNote.addClass(answerIs);
}

// Renvoyer l'évolution du result du joueur
function getScore(){
    score = result*100/position;

    // console.log("rslt: "+score+" / exLength :"+exerciseLength);
}

// Renvoyer le result du joueur à la fin
function getFinalScore(){
    var tt, tc, score = 0; // temps réponses total, temps réponses correctes
    var totalTime = 0;
    var totalTimeCorrect = 0;
    var totalCorrectAnswers = 0;
    var bpm = 0;
    var timePc = 0;

    for(var i = 1; i < inputDuration.length; i++){
        totalTime += inputDuration[i];
        if(answersType[i] == "correct"){
            totalTimeCorrect += inputDuration[i];
            totalCorrectAnswers++;
        }
    }
    tt = (totalTime/(inputDuration.length - 1))/10;
    tc = (totalTimeCorrect/(totalCorrectAnswers))/10;
    score = result*100/exerciseLength;
    bpm = 60/tc;
    timePc = bpm*100/targetTempo; // 200 = bpm cible

    $(".position").hide();

    displayResultsBox(score, result, tc, tt, bpm, timePc);
}

function displayResultsBox(s, r, tc, tt, bpm, timePc){
    // results + cliquer pour cleaner notes + afficher setup;

    var circleScorePc = Math.floor(s / 10) * 10;
    var circleTimePc = Math.floor(timePc / 10) * 10;

    if(circleTimePc > 99){
        circleTimePc = 100;
    }

    $(".overlay").removeClass("hidden");
    $(".overlay #modal-choice").hide();

    $(".overlay #modal-results").css("opacity", 0);
    $(".overlay #modal-results").css("display", "block");
    $(".overlay #modal-results").animate({
        opacity: 1,
    }, 1000);
    $("#modal-results .score .column--percent figcaption").empty().removeClass().addClass("pc-"+circleScorePc).append(roundWithPrecision(s, 0)+"<span class='pc'>%</span>");
    $("#modal-results .score .column--percent svg").removeClass().addClass("pc-"+circleScorePc);
    $("#modal-results .score .column--sentence h3").empty().removeClass().addClass("pc-"+circleScorePc).append("Continuez !");
    $("#modal-results .score .column--details p").empty().append(roundWithPrecision(r, 2)+" bonnes réponses");
    $("#modal-results .time .column--percent figcaption").empty().removeClass().addClass("pc-"+circleTimePc).append(roundWithPrecision(timePc, 0)+"<span class='pc'>%</span>");
    $("#modal-results .time .column--percent svg").removeClass().addClass("pc-"+circleTimePc);
    $("#modal-results .time .column--sentence h3").empty().removeClass().addClass("pc-"+circleTimePc).append("<img src='public/assets/images/note.svg' class='time--note'/> = "+roundWithPrecision(bpm, 0));
    // $("#modal-results .time .column--details p").empty().append(roundWithPrecision(tt, 2)+" à toutes les réponses");

    //get bpm score

    $("#modal-reset").click(function(){
        reset();
    });
}

function roundWithPrecision(number, precision){
    var factor = Math.pow(10, precision);
    var tempNumber = number * factor;
    var roundedTempNumber = Math.round(tempNumber);
    return roundedTempNumber / factor;
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFsbC5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUb3V0IGxlIGNvZGUgZXN0IGNyw6nDqSBmcm9tIHNjcmF0Y2ggcGFyIFRob21hcyBHdWVzbm9uIGVuIDIwMTcuIGh0dHA6Ly93d3cudGhvbWFzZ3Vlc25vbi5mclxuLy8gQXZlYyBsJ2FpZGUgZGUgalF1ZXJ5IHF1YW5kIG3Dqm1lLCBldCBkZSBncm93bC5qcXVlcnkuanMgcG91ciBsZXMgbm90aWZzIOKAlCBjZi4gbGlnbmUgODguXG52YXIgc3RhcnQgPSBudWxsO1xudmFyIGQ7XG5cbi8vIFZhcmlhYmxlcyBleHBvc8OpZXNcbnZhciBrZXk7XG52YXIgZXhlcmNpc2VMZW5ndGg7XG5cbnZhciBkdXJlZXMgPSBbMjAsNDAsODBdOyAvLyBsZXMgdHJvaXMgZHVyw6llcyBkaXNwb25pYmxlc1xudmFyIG5vdGVzID0gW1wiYVwiLCBcImJcIiwgXCJjXCIsIFwiZFwiLCBcImVcIiwgXCJmXCIsIFwiZ1wiXTtcbnZhciBub3Rlc0Nob3NlbiA9IFswLCAwLCAwLCAwLCAwLCAwLCAwXTtcbnZhciBub3Rlc0ZyID0gW1wiTGFcIiwgXCJTaVwiLCBcIkRvXCIsIFwiUsOpXCIsIFwiTWlcIiwgXCJGYVwiLCBcIlNvbFwiXTtcbnZhciBvY3RhdmVzID0gWzAsIDEsIDIsIDMsIDQsIDVdO1xudmFyIHByb3Bvc2VkTm90ZTsgLy8gbGEgbm90ZSBwcm9wb3PDqWUgcGFyIGwndXRpbGlzYXRldXIgw6AgbGEgcG9zaXRpb24gY291cmFudGVcbnZhciBwb3NpdGlvbiA9IDA7IC8vIHBvc2l0aW9uIGRlIGwndXRpbGlzYXRldXJcbnZhciByZXN1bHQgPSAwOyAvLyBub21icmUgZGUgYm9ubmVzIHLDqXBvbnNlc1xudmFyIGxpbmVIZWlnaHQgPSA2OyAvLyBoYXV0ZXVyIGRlIGxpZ25lIChyw6lmw6lyZW5jZSBwb3VyIGxlIGxheW91dClcbnZhciBvZmZzZXQgPSAyNjA7IC8vIGTDqWNhbGFnZSBkZXMgbm90ZXMgc3VyIGxhIHBvcnTDqWVcbnZhciBpbnRlcnZhbDsgLy8gdmFyaWFibGUgcG91ciBsYW5jZXIgbGUgY29tcHRhZ2UgZHUgdGVtcHNcbnZhciBkdXJhdGlvbiA9IDA7IC8vIGR1csOpZSBkZSBsYSByw6lwb25zZSBkZSBsJ3V0aWxpc2F0ZXVyIChzdG9ja8OpZSBkYW5zIGlucHV0RHVyYXRpb24gcWQgb24gcmXDp29pdCB1bmUgcsOpcG9uc2UpXG52YXIgdGFyZ2V0VGVtcG8gPSAxMjA7XG52YXIgY2hlY2tlZCA9IDA7IC8vIHNlcnQgw6AgY29udHLDtGxlciBxdSdvbiBhIGJpZW4gc8OpbGVjdGlvbm7DqSBhdSBtb2lucyBkZXV4IG5vdGVzIGRhbnMgY2hvc2VPcHRpb25zKCk7XG5cbnZhciBub3Rlc0Nob3NlbiA9IG5ldyBBcnJheSgpO1xudmFyIG5vdGVzVG9EcmF3ID0gbmV3IEFycmF5KCk7IC8vIHN0b2NrYWdlIGRlcyBub3RlcyDDoCBkZXNzaW5lclxudmFyIGlucHV0RHVyYXRpb24gPSBuZXcgQXJyYXkoKTsgLy8gc3RvY2thZ2UgZGVzIHRlbXBzIG1pcyBwb3VyIHLDqXBvbmRyZVxudmFyIGFuc3dlcnNUeXBlID0gbmV3IEFycmF5KCk7IC8vIHN0b2NrYWdlIGRlcyByw6lwb25zZXMgKGNvcnJlY3Rlcy9pbmNvcnJlY3RlcylcblxuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xuICAgIGNob3NlT3B0aW9ucygpO1xuICAgIG5vdGVzQ2hvc2VuID0gWzAsIDAsIDAsIDAsIDAsIDAsIDBdO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5oaWRlKCk7XG59KTtcblxuZnVuY3Rpb24gcmVzZXQoKXtcbiAgICAkKFwiLm92ZXJsYXkgI21vZGFsLXJlc3VsdHNcIikuaGlkZSgpO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtY2hvaWNlXCIpLnNob3coKTtcbiAgICAkKFwiLm5vdGVzXCIpLmVtcHR5KCkuY3NzKFwibGVmdFwiLCBvZmZzZXQpO1xuICAgICQoXCIucG9zaXRpb25cIikuc2hvdygpO1xuXG4gICAgcG9zaXRpb24gPSAwO1xuICAgIHJlc3VsdCA9IDA7XG4gICAgbm90ZXNUb0RyYXcgPSBbXTtcbiAgICBub3Rlc0Nob3NlbiA9IFswLCAwLCAwLCAwLCAwLCAwLCAwXTtcbiAgICBjaGVja2VkID0gMDtcbiAgICBpbnB1dER1cmF0aW9uID0gW107XG4gICAgYW5zd2Vyc1R5cGUgPSBbXTtcbn1cblxuZnVuY3Rpb24ga2lsbExpc3RlbmVycygpe1xuICAgIC8vIGtpbGwgbGVzIMOpY291dGV1cnMgY2xhdmllciAvIHNvdXJpc1xuICAgICQoXCJib2R5XCIpLm9mZihcImtleWRvd25cIik7XG4gICAgJChcIi5ub3RlLWJ0blwiKS5lYWNoKGZ1bmN0aW9uKCl7XG4gICAgICAgICQodGhpcykub2ZmKFwiY2xpY2tcIik7XG4gICAgfSlcbn1cblxuZnVuY3Rpb24gZ2V0VGltZSgpe1xuICAgIGR1cmF0aW9uKys7XG59XG5cbmZ1bmN0aW9uIGNhcHR1cmVUaW1lKCl7XG4gICAgaW5wdXREdXJhdGlvbi5wdXNoKGR1cmF0aW9uKTtcbiAgICBkdXJhdGlvbiA9IDA7XG59XG5cbi8vIE1vZGFsZSBkZSBjaG9pcyBkZXMgb3B0aW9ucywgYXUgZMOpcGFydFxuZnVuY3Rpb24gY2hvc2VPcHRpb25zKCl7XG5cbiAgICB2YXIgaywgbDtcbiAgICAkKFwiI21vZGFsLXZhbGlkYXRlXCIpLmNsaWNrKGZ1bmN0aW9uKCl7XG4gICAgICAgIGsgPSAkKFwiI2Nob2l4LWNsZWZcIikudmFsKCk7XG4gICAgICAgIGtleSA9IGs7XG4gICAgICAgIGwgPSAkKFwiI2Nob2l4LWR1cmVlXCIpLnZhbCgpO1xuICAgICAgICBleGVyY2lzZUxlbmd0aCA9IGR1cmVlc1tsXTtcblxuICAgICAgICAkKCcuZm9ybS0tY2hlY2tib3ggaW5wdXQnKS5lYWNoKGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBpZigkKHRoaXMpLmlzKCc6Y2hlY2tlZCcpKXtcbiAgICAgICAgICAgICAgICB2YXIgdiA9ICQodGhpcykuYXR0cihcInZhbHVlXCIpO1xuICAgICAgICAgICAgICAgIG5vdGVzQ2hvc2VuW3ZdID0gMTtcbiAgICAgICAgICAgICAgICBjaGVja2VkKys7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIGlmKGNoZWNrZWQgPCAyKXtcbiAgICAgICAgICAgICQuZ3Jvd2wuZXJyb3IoeyB0aXRsZTogXCJUcm9wIHBldSBkZSBub3Rlc1wiLCBtZXNzYWdlOiBcIlZldWlsbGV6IHPDqWxlY3Rpb25uZXIgYXUgbW9pbnMgZGV1eCBub3RlcyDDoCBhZmZpY2hlciBzdXIgbGEgcG9ydMOpZVwiIH0pO1xuICAgICAgICAgICAgY2hlY2tlZCA9IDA7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIGNyZWF0ZU5vdGVzKCk7XG4gICAgICAgICAgICBsaXN0ZW5CdXR0b25zKCk7XG4gICAgICAgICAgICBsaXN0ZW5LZXlzKCk7XG5cbiAgICAgICAgICAgICQoXCIub3ZlcmxheVwiKS5hZGRDbGFzcyhcImhpZGRlblwiKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKG5vdGVzQ2hvc2VuKTtcblxuICAgIH0pO1xufVxuXG4vLyBjcsOpZXIgbGUgdGFibGVhdSBkZSBub3Rlc1xuZnVuY3Rpb24gY3JlYXRlTm90ZXMoKXtcblxuICAgIHZhciBjID0gMDsgLy8gcG91ciBuYXZpZ3VlciBkYW5zIGxlIHRhYmxlYXUgZGVzIG5vdGVzXG4gICAgdmFyIGkgPSAwO1xuXG4gICAgd2hpbGUoaSA8IGV4ZXJjaXNlTGVuZ3RoKXtcbiAgICAgICAgYyA9IGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KDAsIG5vdGVzLmxlbmd0aCk7XG5cbiAgICAgICAgaWYobm90ZXNDaG9zZW5bY10gPT0gMSl7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9rXCIpO1xuICAgICAgICAgICAgbm90ZXNUb0RyYXcucHVzaChub3Rlc1tjXSk7XG4gICAgICAgICAgICBkcmF3Tm90ZXMobm90ZXNUb0RyYXdbaV0sIGtleSk7XG4gICAgICAgICAgICBpKys7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm5vXCIpO1xuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhub3Rlc1RvRHJhdyk7XG59XG5cbi8vIERlc3NpbmVyIGxlcyBub3RlcyBzdXIgbGEgcG9ydMOpZVxuZnVuY3Rpb24gZHJhd05vdGVzKG5vdGUsIGspe1xuICAgIHZhciBuID0gbm90ZTtcbiAgICB2YXIgbyA9IDM7XG5cbiAgICAkKFwiLnBvcnRlZVwiKS5yZW1vdmVBdHRyKFwiaWRcIikuYXR0cihcImlkXCIsIFwicG9ydGVlLVwiK2tleSk7XG5cbiAgICBpZihrID09IFwic29sXCIpe1xuICAgICAgICBvID0gZ2V0Rmxvb3JSYW5kb21BcmJpdHJhcnkoMiwgNik7XG4gICAgfVxuICAgIGlmKGsgPT0gXCJmYVwiKXtcbiAgICAgICAgbyA9IGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KDAsIDMpO1xuICAgIH1cblxuICAgICQoXCIubm90ZXNcIikuYXBwZW5kKFwiPGRpdiBjbGFzcz0nbm90ZSBcIituK1wiIGdyXCIrbytcIic+PC9kaXY+XCIpXG59XG5cbi8vIGZvbmN0aW9uIHV0aWxpdGFpcmUgcG91ciByZW52b3llciB1biBub21icmUgYWzDqWF0b2lyZSBlbnRyZSBkZXV4IHZhbGV1cnNcbmZ1bmN0aW9uIGdldEZsb29yUmFuZG9tQXJiaXRyYXJ5KG1pbiwgbWF4KSB7XG4gICAgcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pICsgbWluKTtcbn1cblxuZnVuY3Rpb24gbGlzdGVuQnV0dG9ucygpe1xuICAgICQoXCIubm90ZS1idG5cIikuZWFjaChmdW5jdGlvbihpKXtcbiAgICAgICAgJCh0aGlzKS5jbGljayhmdW5jdGlvbigpe1xuICAgICAgICAgICAgdmFyIGNsYXNzZXMgPSAkKHRoaXMpLmF0dHIoJ2NsYXNzJykuc3BsaXQoJyAnKTtcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IGNsYXNzZXNbMV07IC8vIHJlbnZvaWUgbGUgbm9tIGRlIGxhIGNsYXNzZSBhc3NvY2nDqSBhdSBib3V0b25cbiAgICAgICAgICAgIHNldEJ1dHRvbkFjdGl2ZSgpO1xuICAgICAgICAgICAgc2VuZE5vdGUoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59XG5cbi8vIEVjb3V0ZXIgbGVzIHRvdWNoZXMgZHUgY2xhdmllclxuZnVuY3Rpb24gbGlzdGVuS2V5cygpe1xuXHQkKFwiYm9keVwiKS5rZXlkb3duKGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cblx0XHRpZiAoIGV2ZW50LmtleUNvZGUgPT0gNjUgKSB7IC8vIHRvdWNoZSBBXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImNcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDkwICkgeyAvLyB0b3VjaGUgWlxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJkXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA2OSApIHsgLy8gdG91Y2hlIEVcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiZVwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODIgKSB7IC8vIHRvdWNoZSBSXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImZcIjtcblx0XHR9XG4gICAgICAgIGVsc2UgaWYgKCBldmVudC5rZXlDb2RlID09IDg0ICkgeyAvLyB0b3VjaGUgVFxuICAgICAgICAgICAgcHJvcG9zZWROb3RlID0gXCJnXCI7XG5cdFx0fVxuICAgICAgICBlbHNlIGlmICggZXZlbnQua2V5Q29kZSA9PSA4OSApIHsgLy8gdG91Y2hlIFlcbiAgICAgICAgICAgIHByb3Bvc2VkTm90ZSA9IFwiYVwiO1xuXHRcdH1cbiAgICAgICAgZWxzZSBpZiAoIGV2ZW50LmtleUNvZGUgPT0gODUgKSB7IC8vIHRvdWNoZSBVXG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImJcIjtcblx0XHR9XG4gICAgICAgIGVsc2V7XG4gICAgICAgICAgICBwcm9wb3NlZE5vdGUgPSBcImNcIjsgLy8gU2kgb24gZXN0IGRlaG9ycywgb24gcsOpdGFibGl0IHN1ciBEby9DXG4gICAgICAgIH1cblxuICAgICAgICBzZXRCdXR0b25BY3RpdmUoKTtcbiAgICAgICAgc2VuZE5vdGUoKTtcblx0fSk7XG59XG5cbmZ1bmN0aW9uIHNldEJ1dHRvbkFjdGl2ZSgpe1xuICAgICQoXCIubm90ZS1idG5cIikuZWFjaChmdW5jdGlvbihpKXtcbiAgICAgICAgaWYoJCh0aGlzKS5oYXNDbGFzcyhwcm9wb3NlZE5vdGUpKXtcbiAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2FjdGl2ZScpO1xuICAgICAgICAgICAgdmFyIGludGVydmFsSUQgPSBzZXRUaW1lb3V0KCgpID0+IHsgY2xlYXJBY3RpdmUoJCh0aGlzKSk7IH0sIDUwMCk7XG4gICAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gY29udmVydE5vdGVzVG9Gcihub3RlVG9Db252ZXJ0KXtcbiAgICBmb3IoaSA9IDA7IGk8bm90ZXMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZihub3RlVG9Db252ZXJ0ID09IG5vdGVzW2ldKXtcbiAgICAgICAgICAgIHJldHVybiBub3Rlc0ZyW2ldO1xuICAgICAgICB9XG4gICAgfVxufVxuXG5mdW5jdGlvbiBjbGVhckFjdGl2ZSh0KXtcbiAgICB0LnJlbW92ZUNsYXNzKCdhY3RpdmUnKTtcbn1cblxuZnVuY3Rpb24gc2VuZE5vdGUoKXtcbiAgICBpZihwb3NpdGlvbiA9PSAwKXtcbiAgICAgICAgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChcImdldFRpbWUoKVwiLCAxMDApO1xuICAgICAgICBpbnB1dER1cmF0aW9uLnB1c2goMCk7IC8vIE9uIGTDqW1hcnJlIGxlIGNocm9ubywgZXQgbGEgcHJlbWnDqHJlIHZhbGV1ciBlc3QgesOpcm8gKG9uIGwnZW5sw6h2ZXJhIGR1IGTDqWNvbXB0ZSBmaW5hbClcbiAgICB9XG4gICAgZWxzZXtcbiAgICAgICAgY2FwdHVyZVRpbWUoKTtcbiAgICB9XG4gICAgY29udHJvbElucHV0KHByb3Bvc2VkTm90ZSk7XG5cbiAgICBpZihwb3NpdGlvbiA8IG5vdGVzVG9EcmF3Lmxlbmd0aC0xKXsgLy8gU2kgY2Ugbidlc3QgcGFzIGZpbmlcbiAgICAgICAgcG9zaXRpb24rKztcbiAgICAgICAgZ2V0U2NvcmUoKTtcbiAgICB9XG4gICAgZWxzZXsgLy8gU2kgYydlc3QgdGVybWluw6lcbiAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgIGtpbGxMaXN0ZW5lcnMoKTtcbiAgICAgICAgZ2V0RmluYWxTY29yZSgpO1xuICAgIH1cbiAgICBtb3ZlUG9zaXRpb25Gb3J3YXJkKCk7XG59XG5cbi8vIEF2YW5jZXIgbGEgdMOqdGUgZGUgbGVjdHVyZVxuZnVuY3Rpb24gbW92ZVBvc2l0aW9uRm9yd2FyZCgpe1xuICAgIHZhciBuZXdQb3MgPSBwb3NpdGlvbio1MjtcblxuICAgICQoXCIubm90ZXNcIikuYW5pbWF0ZSh7XG4gICAgICAgIGxlZnQ6IChvZmZzZXQrMC1uZXdQb3MpXG4gICAgfSwyNTAsZnVuY3Rpb24oKXtcbiAgICAgICAgLy8gc29tZXRoaW5nXG4gICAgfSk7XG59XG5cbi8vIENvbnRyw7RsZXIgc2kgbGUgcsOpc3VsdGF0IGVudHLDqSBlc3QgbGUgYm9uXG5mdW5jdGlvbiBjb250cm9sSW5wdXQoKXtcbiAgICB2YXIgYW5zd2VySXM7XG4gICAgdmFyIGN1cnJlbnROb3RlID0gJChcIi5ub3Rlc1wiKS5maW5kKFwiLm5vdGVcIikuZXEocG9zaXRpb24pO1xuXG4gICAgaWYocHJvcG9zZWROb3RlID09IG5vdGVzVG9EcmF3W3Bvc2l0aW9uXSl7XG4gICAgICAgIGFuc3dlcklzID0gXCJjb3JyZWN0XCI7XG4gICAgICAgIGN1cnJlbnROb3RlLmFwcGVuZChcIjxkaXYgY2xhc3M9J2NoZWNrLW5vdGUnPuKckzwvZGl2PlwiKTtcbiAgICAgICAgcmVzdWx0Kys7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBhbnN3ZXJJcyA9IFwid3JvbmdcIjtcbiAgICAgICAgY3VycmVudE5vdGUuYXBwZW5kKFwiPGRpdiBjbGFzcz0nY29ycmVjdC1ub3RlJz5cIitjb252ZXJ0Tm90ZXNUb0ZyKG5vdGVzVG9EcmF3W3Bvc2l0aW9uXSkrXCI8L2Rpdj5cIik7XG4gICAgfVxuXG4gICAgYW5zd2Vyc1R5cGUucHVzaChhbnN3ZXJJcyk7IC8vIE9uIHB1c2hlIGwnYW5zd2VyIGRhbnMgbGUgdGFibGVhdSBkZXMgcsOpcG9uc2VzXG4gICAgY3VycmVudE5vdGUuYWRkQ2xhc3MoYW5zd2VySXMpO1xufVxuXG4vLyBSZW52b3llciBsJ8Opdm9sdXRpb24gZHUgcmVzdWx0IGR1IGpvdWV1clxuZnVuY3Rpb24gZ2V0U2NvcmUoKXtcbiAgICBzY29yZSA9IHJlc3VsdCoxMDAvcG9zaXRpb247XG5cbiAgICAvLyBjb25zb2xlLmxvZyhcInJzbHQ6IFwiK3Njb3JlK1wiIC8gZXhMZW5ndGggOlwiK2V4ZXJjaXNlTGVuZ3RoKTtcbn1cblxuLy8gUmVudm95ZXIgbGUgcmVzdWx0IGR1IGpvdWV1ciDDoCBsYSBmaW5cbmZ1bmN0aW9uIGdldEZpbmFsU2NvcmUoKXtcbiAgICB2YXIgdHQsIHRjLCBzY29yZSA9IDA7IC8vIHRlbXBzIHLDqXBvbnNlcyB0b3RhbCwgdGVtcHMgcsOpcG9uc2VzIGNvcnJlY3Rlc1xuICAgIHZhciB0b3RhbFRpbWUgPSAwO1xuICAgIHZhciB0b3RhbFRpbWVDb3JyZWN0ID0gMDtcbiAgICB2YXIgdG90YWxDb3JyZWN0QW5zd2VycyA9IDA7XG4gICAgdmFyIGJwbSA9IDA7XG4gICAgdmFyIHRpbWVQYyA9IDA7XG5cbiAgICBmb3IodmFyIGkgPSAxOyBpIDwgaW5wdXREdXJhdGlvbi5sZW5ndGg7IGkrKyl7XG4gICAgICAgIHRvdGFsVGltZSArPSBpbnB1dER1cmF0aW9uW2ldO1xuICAgICAgICBpZihhbnN3ZXJzVHlwZVtpXSA9PSBcImNvcnJlY3RcIil7XG4gICAgICAgICAgICB0b3RhbFRpbWVDb3JyZWN0ICs9IGlucHV0RHVyYXRpb25baV07XG4gICAgICAgICAgICB0b3RhbENvcnJlY3RBbnN3ZXJzKys7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdHQgPSAodG90YWxUaW1lLyhpbnB1dER1cmF0aW9uLmxlbmd0aCAtIDEpKS8xMDtcbiAgICB0YyA9ICh0b3RhbFRpbWVDb3JyZWN0Lyh0b3RhbENvcnJlY3RBbnN3ZXJzKSkvMTA7XG4gICAgc2NvcmUgPSByZXN1bHQqMTAwL2V4ZXJjaXNlTGVuZ3RoO1xuICAgIGJwbSA9IDYwL3RjO1xuICAgIHRpbWVQYyA9IGJwbSoxMDAvdGFyZ2V0VGVtcG87IC8vIDIwMCA9IGJwbSBjaWJsZVxuXG4gICAgJChcIi5wb3NpdGlvblwiKS5oaWRlKCk7XG5cbiAgICBkaXNwbGF5UmVzdWx0c0JveChzY29yZSwgcmVzdWx0LCB0YywgdHQsIGJwbSwgdGltZVBjKTtcbn1cblxuZnVuY3Rpb24gZGlzcGxheVJlc3VsdHNCb3gocywgciwgdGMsIHR0LCBicG0sIHRpbWVQYyl7XG4gICAgLy8gcmVzdWx0cyArIGNsaXF1ZXIgcG91ciBjbGVhbmVyIG5vdGVzICsgYWZmaWNoZXIgc2V0dXA7XG5cbiAgICB2YXIgY2lyY2xlU2NvcmVQYyA9IE1hdGguZmxvb3IocyAvIDEwKSAqIDEwO1xuICAgIHZhciBjaXJjbGVUaW1lUGMgPSBNYXRoLmZsb29yKHRpbWVQYyAvIDEwKSAqIDEwO1xuXG4gICAgaWYoY2lyY2xlVGltZVBjID4gOTkpe1xuICAgICAgICBjaXJjbGVUaW1lUGMgPSAxMDA7XG4gICAgfVxuXG4gICAgJChcIi5vdmVybGF5XCIpLnJlbW92ZUNsYXNzKFwiaGlkZGVuXCIpO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtY2hvaWNlXCIpLmhpZGUoKTtcblxuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5jc3MoXCJvcGFjaXR5XCIsIDApO1xuICAgICQoXCIub3ZlcmxheSAjbW9kYWwtcmVzdWx0c1wiKS5jc3MoXCJkaXNwbGF5XCIsIFwiYmxvY2tcIik7XG4gICAgJChcIi5vdmVybGF5ICNtb2RhbC1yZXN1bHRzXCIpLmFuaW1hdGUoe1xuICAgICAgICBvcGFjaXR5OiAxLFxuICAgIH0sIDEwMDApO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAuc2NvcmUgLmNvbHVtbi0tcGVyY2VudCBmaWdjYXB0aW9uXCIpLmVtcHR5KCkucmVtb3ZlQ2xhc3MoKS5hZGRDbGFzcyhcInBjLVwiK2NpcmNsZVNjb3JlUGMpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24ocywgMCkrXCI8c3BhbiBjbGFzcz0ncGMnPiU8L3NwYW4+XCIpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAuc2NvcmUgLmNvbHVtbi0tcGVyY2VudCBzdmdcIikucmVtb3ZlQ2xhc3MoKS5hZGRDbGFzcyhcInBjLVwiK2NpcmNsZVNjb3JlUGMpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAuc2NvcmUgLmNvbHVtbi0tc2VudGVuY2UgaDNcIikuZW1wdHkoKS5yZW1vdmVDbGFzcygpLmFkZENsYXNzKFwicGMtXCIrY2lyY2xlU2NvcmVQYykuYXBwZW5kKFwiQ29udGludWV6ICFcIik7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC5zY29yZSAuY29sdW1uLS1kZXRhaWxzIHBcIikuZW1wdHkoKS5hcHBlbmQocm91bmRXaXRoUHJlY2lzaW9uKHIsIDIpK1wiIGJvbm5lcyByw6lwb25zZXNcIik7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC50aW1lIC5jb2x1bW4tLXBlcmNlbnQgZmlnY2FwdGlvblwiKS5lbXB0eSgpLnJlbW92ZUNsYXNzKCkuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVUaW1lUGMpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24odGltZVBjLCAwKStcIjxzcGFuIGNsYXNzPSdwYyc+JTwvc3Bhbj5cIik7XG4gICAgJChcIiNtb2RhbC1yZXN1bHRzIC50aW1lIC5jb2x1bW4tLXBlcmNlbnQgc3ZnXCIpLnJlbW92ZUNsYXNzKCkuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVUaW1lUGMpO1xuICAgICQoXCIjbW9kYWwtcmVzdWx0cyAudGltZSAuY29sdW1uLS1zZW50ZW5jZSBoM1wiKS5lbXB0eSgpLnJlbW92ZUNsYXNzKCkuYWRkQ2xhc3MoXCJwYy1cIitjaXJjbGVUaW1lUGMpLmFwcGVuZChcIjxpbWcgc3JjPSdwdWJsaWMvYXNzZXRzL2ltYWdlcy9ub3RlLnN2ZycgY2xhc3M9J3RpbWUtLW5vdGUnLz4gPSBcIityb3VuZFdpdGhQcmVjaXNpb24oYnBtLCAwKSk7XG4gICAgLy8gJChcIiNtb2RhbC1yZXN1bHRzIC50aW1lIC5jb2x1bW4tLWRldGFpbHMgcFwiKS5lbXB0eSgpLmFwcGVuZChyb3VuZFdpdGhQcmVjaXNpb24odHQsIDIpK1wiIMOgIHRvdXRlcyBsZXMgcsOpcG9uc2VzXCIpO1xuXG4gICAgLy9nZXQgYnBtIHNjb3JlXG5cbiAgICAkKFwiI21vZGFsLXJlc2V0XCIpLmNsaWNrKGZ1bmN0aW9uKCl7XG4gICAgICAgIHJlc2V0KCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIHJvdW5kV2l0aFByZWNpc2lvbihudW1iZXIsIHByZWNpc2lvbil7XG4gICAgdmFyIGZhY3RvciA9IE1hdGgucG93KDEwLCBwcmVjaXNpb24pO1xuICAgIHZhciB0ZW1wTnVtYmVyID0gbnVtYmVyICogZmFjdG9yO1xuICAgIHZhciByb3VuZGVkVGVtcE51bWJlciA9IE1hdGgucm91bmQodGVtcE51bWJlcik7XG4gICAgcmV0dXJuIHJvdW5kZWRUZW1wTnVtYmVyIC8gZmFjdG9yO1xufVxuIl19
